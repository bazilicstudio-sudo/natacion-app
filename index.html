<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO</title>

<style>
body{
margin:0;
font-family:sans-serif;
background:#0f172a;
color:white;
padding:10px;
}
.card{
background:#1f2937;
padding:15px;
border-radius:15px;
margin-bottom:15px;
}
button{
padding:12px;
margin:6px 0;
border:none;
border-radius:12px;
font-weight:bold;
cursor:pointer;
font-size:16px;
width:100%;
}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
.lane{
background:#111827;
padding:15px;
margin:10px 0;
border-radius:15px;
text-align:center;
}
.lane.finished{background:#1e293b;}
.timeDisplay{
font-size:26px;
font-weight:bold;
margin:10px 0;
}
.hidden{display:none}
input,select{
width:100%;
padding:8px;
margin:5px 0;
border-radius:8px;
border:none;
}
img{
max-width:100px;
border-radius:50%;
margin-top:10px;
}
.medal{
font-size:22px;
}
</style>
</head>
<body>

<h2>游끩 Sistema Competencia Elite PRO</h2>

<!-- LOGIN -->
<div id="loginCard" class="card">
<h3>Iniciar Sesi칩n</h3>

<select id="roleSelect">
<option value="admin">Entrenador</option>
<option value="athlete">Atleta</option>
</select>

<input type="text" id="loginUser" placeholder="Usuario">
<input type="password" id="loginPass" placeholder="Contrase침a">

<button class="btn" onclick="login()">Ingresar</button>
</div>

<div id="app" class="hidden">

<div class="card">
<button class="btn-danger" onclick="logout()">Cerrar Sesi칩n</button>
</div>

<!-- PANEL ADMIN -->
<div id="adminPanel" class="hidden">

<div class="card">
<h3>Crear Atleta</h3>
<input type="text" id="newAthlete" placeholder="Usuario">
<input type="password" id="newPass" placeholder="Contrase침a">
<input type="number" id="newAge" placeholder="Edad">
<select id="newGender">
<option value="">Sexo</option>
<option value="Masculino">Masculino</option>
<option value="Femenino">Femenino</option>
</select>
<input type="text" id="newCategory" placeholder="Categor칤a">
<button class="btn-success" onclick="createAthlete()">Crear Atleta</button>
</div>

<div class="card">
<h3>Lista Atletas</h3>
<div id="athleteList"></div>
<button class="btn" onclick="downloadAthletes()">Descargar Lista</button>
</div>

</div>

<!-- PANEL ATLETA -->
<div id="athletePanel" class="hidden">

<div class="card">
<h3>Mi Perfil</h3>
<div id="profileInfo"></div>

<input type="file" id="photoInput">
<input type="text" id="editPhone" placeholder="Tel칠fono">
<input type="email" id="editEmail" placeholder="Correo">

<button class="btn-success" onclick="saveProfile()">Guardar Cambios</button>
<button class="btn" onclick="downloadMyResults()">Descargar Mis Resultados</button>
</div>

</div>

<!-- COMPETENCIA -->
<div class="card">
<h3>Competencia</h3>
<input type="number" id="laneCount" value="4" min="2" max="10">
<button class="btn-success" onclick="startCompetition()">Crear Carriles</button>
<button class="btn-danger" onclick="prepareStart()">游뚽 PREPARADOS</button>
<div id="lanes"></div>
</div>

<div class="card">
<h3>Ranking</h3>
<div id="ranking"></div>
<button class="btn" onclick="downloadResults()">Descargar Resultados</button>
</div>

</div>

<script>

let currentUser=null;
let currentRole=null;
let results=[];
let laneTimers={};
let globalStartTime;
let globalInterval;
let reactionStartTime;
let raceStarted=false;

if(!localStorage.getItem("admin")){
localStorage.setItem("admin",
JSON.stringify({user:"admin",pass:"1234"}));
}

function login(){

let role=roleSelect.value;
let admin=JSON.parse(localStorage.getItem("admin"));
let athletes=JSON.parse(localStorage.getItem("athletes")||"[]");

if(role==="admin"){
if(loginUser.value===admin.user && loginPass.value===admin.pass){
currentRole="admin";
currentUser=admin.user;
adminPanel.classList.remove("hidden");
}
else{alert("Credenciales incorrectas");return;}
}
else{
let athlete=athletes.find(a=>a.user===loginUser.value && a.pass===loginPass.value);
if(!athlete){alert("Credenciales incorrectas");return;}
currentRole="athlete";
currentUser=athlete.user;
athletePanel.classList.remove("hidden");
loadProfile();
}

loginCard.classList.add("hidden");
app.classList.remove("hidden");
loadAthletes();
}

function logout(){location.reload();}

function createAthlete(){
let athletes=JSON.parse(localStorage.getItem("athletes")||"[]");
athletes.push({
user:newAthlete.value,
pass:newPass.value,
age:newAge.value,
gender:newGender.value,
category:newCategory.value,
phone:"",
email:"",
photo:""
});
localStorage.setItem("athletes",JSON.stringify(athletes));
loadAthletes();
}

function loadAthletes(){
let athletes=JSON.parse(localStorage.getItem("athletes")||"[]");
athleteList.innerHTML="";
athletes.forEach(a=>{
athleteList.innerHTML+=`
<div>
${a.user} | ${a.gender} | ${a.age}
<button onclick="deleteAthlete('${a.user}')">Eliminar</button>
</div>`;
});
}

function deleteAthlete(user){
let athletes=JSON.parse(localStorage.getItem("athletes")||"[]");
athletes=athletes.filter(a=>a.user!==user);
localStorage.setItem("athletes",JSON.stringify(athletes));
loadAthletes();
}

function loadProfile(){
let athletes=JSON.parse(localStorage.getItem("athletes")||"[]");
let athlete=athletes.find(a=>a.user===currentUser);

profileInfo.innerHTML=`
Usuario: ${athlete.user}<br>
Edad: ${athlete.age}<br>
Sexo: ${athlete.gender}<br>
Categor칤a: ${athlete.category}<br>
<img src="${athlete.photo||''}">
`;

editPhone.value=athlete.phone||"";
editEmail.value=athlete.email||"";
}

function saveProfile(){
let athletes=JSON.parse(localStorage.getItem("athletes")||"[]");
let athlete=athletes.find(a=>a.user===currentUser);

athlete.phone=editPhone.value;
athlete.email=editEmail.value;

let file=photoInput.files[0];
if(file){
let reader=new FileReader();
reader.onload=function(e){
athlete.photo=e.target.result;
localStorage.setItem("athletes",JSON.stringify(athletes));
loadProfile();
};
reader.readAsDataURL(file);
}else{
localStorage.setItem("athletes",JSON.stringify(athletes));
loadProfile();
}
}

function startCompetition(){
lanes.innerHTML="";
results=[];
laneTimers={};

let athletes=JSON.parse(localStorage.getItem("athletes")||"[]");

for(let i=1;i<=laneCount.value;i++){
laneTimers[i]={finished:false,currentTime:0,athlete:null};

let options=athletes.map(a=>
`<option value="${a.user}">${a.user}</option>`).join("");

lanes.innerHTML+=`
<div class="lane" id="lane${i}">
Carril ${i}
<select onchange="laneTimers[${i}].athlete=this.value">
<option value="">Asignar atleta</option>
${options}
</select>
<div class="timeDisplay" id="time${i}">0.000</div>
<button onclick="finishLane(${i})">TOCAR</button>
</div>`;
}
}

function prepareStart(){
raceStarted=false;
let delay=Math.floor(Math.random()*2000)+1000;
setTimeout(()=>{
reactionStartTime=Date.now();
raceStarted=true;
globalStartTime=Date.now();
globalInterval=setInterval(updateTimers,10);
},delay);
}

function updateTimers(){
let now=Date.now();
for(let i in laneTimers){
if(!laneTimers[i].finished){
let elapsed=now-globalStartTime;
laneTimers[i].currentTime=elapsed;
document.getElementById("time"+i).innerText=
(elapsed/1000).toFixed(3);
}
}
}

function finishLane(i){
if(laneTimers[i].finished)return;
laneTimers[i].finished=true;

let finalTime=laneTimers[i].currentTime/1000;
let reaction=(Date.now()-reactionStartTime)/1000;

results.push({
name:laneTimers[i].athlete||"Sin atleta",
time:finalTime,
reaction:reaction
});

results.sort((a,b)=>a.time-b.time);
renderRanking();
}

function renderRanking(){
ranking.innerHTML="";
results.forEach((r,index)=>{
let medal="";
if(index===0)medal="游볞";
if(index===1)medal="游볟";
if(index===2)medal="游볠";

ranking.innerHTML+=`
<div>
<span class="medal">${medal}</span>
${index+1}춿 ${r.name}
| ${r.time.toFixed(3)}s
| Reacci칩n ${r.reaction.toFixed(3)}s
</div>`;
});
}

function downloadFile(name,text){
let blob=new Blob([text],{type:"text/plain"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download=name;
a.click();
}

function downloadAthletes(){
let athletes=JSON.parse(localStorage.getItem("athletes")||"[]");
let text="LISTA ATLETAS\n\n";
athletes.forEach(a=>{
text+=`${a.user} - ${a.email} - ${a.phone}\n`;
});
downloadFile("atletas.txt",text);
}

function downloadResults(){
let text="RESULTADOS\n\n";
results.forEach(r=>{
text+=`${r.name} - ${r.time}s - ${r.reaction}s\n`;
});
downloadFile("resultados.txt",text);
}

function downloadMyResults(){
let text="MIS RESULTADOS\n\n";
results.filter(r=>r.name===currentUser)
.forEach(r=>{
text+=`${r.time}s - ${r.reaction}s\n`;
});
downloadFile("mis_resultados.txt",text);
}

</script>
</body>
</html>
