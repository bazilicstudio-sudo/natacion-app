<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO MAX</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:white}
.lane{background:#111827;padding:15px;margin:10px 0;border-radius:15px;text-align:center;}
.timeDisplay{font-size:22px;font-weight:bold;margin:10px 0;}
.hidden{display:none}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
.small-btn{padding:5px;font-size:12px;width:auto;margin-right:5px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #334155;padding:6px;text-align:center;}
</style>
</head>
<body>

<h2>üèä Sistema Competencia Elite PRO MAX</h2>

<div id="loginCard" class="card">
<h3>Iniciar Sesi√≥n</h3>
<input type="text" id="loginUser" placeholder="Usuario">
<button class="btn" onclick="login()">Ingresar</button>
</div>

<div id="app" class="hidden">

<div class="card">
<h3>Atletas</h3>
<input type="text" id="newAthleteUser" placeholder="Nombre atleta">
<input type="number" id="newAthleteAge" placeholder="Edad">
<select id="newAthleteSex">
<option value="">Sexo</option>
<option value="Masculino">Masculino</option>
<option value="Femenino">Femenino</option>
</select>
<button class="btn-success" onclick="createAthlete()">Crear Atleta</button>
<div id="athleteList"></div>
</div>

<div class="card">
<h3>üìã Datos de la Prueba</h3>
<input type="text" id="testName" placeholder="Nombre prueba">
<input type="number" id="testDistance" placeholder="Metros">
<input type="date" id="testDate">
<button class="btn-success" onclick="activateTest()">Activar Prueba</button>
<div id="activeTestInfo"></div>
</div>

<div class="card">
<h3>Competencia</h3>
<input type="number" id="laneCount" value="4" min="2" max="10">
<button class="btn-success" onclick="startCompetition()">Crear Carriles</button>
<button class="btn-success" onclick="startRaceNow()">üö¶ INICIAR</button>
<button class="btn-danger" onclick="resetRace()">üîÑ Reiniciar</button>
<div id="lanes"></div>
</div>

<div class="card">
<h3>Ranking</h3>
<div id="ranking"></div>
</div>

<div class="card">
<h3>üìä Estad√≠sticas Visuales</h3>
<div id="statsTable"></div>
</div>

<div class="card">
<h3>üìà Progreso del Atleta</h3>
<select id="graphAthleteSelect" onchange="renderGraph()"></select>
<canvas id="progressChart"></canvas>
</div>

</div>

<script>

/* ================= BASE ================= */

function safeParse(key){
try{return JSON.parse(localStorage.getItem(key))||[];}
catch{return [];}
}

let athletes=safeParse("athletes");
let allTests=safeParse("allTests");
let currentTest=null;
let chart=null;

function login(){
loginCard.classList.add("hidden");
app.classList.remove("hidden");
renderAll();
}

/* ================= ATLETAS ================= */

function createAthlete(){
if(!newAthleteUser.value)return;
athletes.push({
user:newAthleteUser.value,
age:newAthleteAge.value||"",
sex:newAthleteSex.value||""
});
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

function editAthlete(index){
let a=athletes[index];
let nombre=prompt("Editar nombre:",a.user);
if(!nombre)return;
let edad=prompt("Editar edad:",a.age);
let sexo=prompt("Editar sexo:",a.sex);
athletes[index]={user:nombre,age:edad||"",sex:sexo||""};
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

function deleteAthlete(index){
if(!confirm("Eliminar atleta?"))return;
athletes.splice(index,1);
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

function renderAthletes(){
athleteList.innerHTML="";
graphAthleteSelect.innerHTML="";
athletes.forEach((a,i)=>{
athleteList.innerHTML+=`
${a.user} | Edad:${a.age||"-"} | Sexo:${a.sex||"-"}
<button class="small-btn btn-warning" onclick="editAthlete(${i})">Editar</button>
<button class="small-btn btn-danger" onclick="deleteAthlete(${i})">Eliminar</button><br>`;
graphAthleteSelect.innerHTML+=`<option>${a.user}</option>`;
});
}

/* ================= PRUEBAS ================= */

function activateTest(){
currentTest={
name:testName.value,
distance:testDistance.value,
date:testDate.value,
results:[]
};
allTests.push(currentTest);
localStorage.setItem("allTests",JSON.stringify(allTests));
activeTestInfo.innerHTML=`Activa: ${currentTest.name}`;
}

/* ================= CRONOMETRO ================= */

let laneTimers={},results=[],interval,startTime;

function startCompetition(){
lanes.innerHTML="";
laneTimers={};
results=[];
for(let i=1;i<=laneCount.value;i++){
laneTimers[i]={finished:false,time:0,athlete:null};
let options=athletes.map(a=>`<option>${a.user}</option>`).join("");
lanes.innerHTML+=`
<div class="lane">
Carril ${i}
<select onchange="laneTimers[${i}].athlete=this.value">
<option></option>${options}
</select>
<div class="timeDisplay" id="time${i}">0.000</div>
<button onclick="finishLane(${i})">TOCAR</button>
</div>`;
}
}

function startRaceNow(){
startTime=Date.now();
interval=setInterval(()=>{
let t=Date.now()-startTime;
for(let i in laneTimers){
if(!laneTimers[i].finished){
laneTimers[i].time=t;
document.getElementById("time"+i).innerText=(t/1000).toFixed(3);
}
}
},10);
}

function resetRace(){
clearInterval(interval);
results=[];
ranking.innerHTML="";
for(let i in laneTimers){
laneTimers[i].finished=false;
laneTimers[i].time=0;
document.getElementById("time"+i).innerText="0.000";
}
}

function finishLane(i){
if(laneTimers[i].finished)return;
laneTimers[i].finished=true;
let final=laneTimers[i].time/1000;
let name=laneTimers[i].athlete||"Sin atleta";
results.push({name,time:final});

if(currentTest){
currentTest.results.push({athlete:name,time:final});
localStorage.setItem("allTests",JSON.stringify(allTests));
}

renderRanking();
renderStats();
renderGraph();
}

function renderRanking(){
ranking.innerHTML="";
results.sort((a,b)=>a.time-b.time);
results.forEach((r,i)=>{
ranking.innerHTML+=`${i+1}¬∞ ${r.name} - ${r.time.toFixed(3)}s<br>`;
});
}

/* ================= TABLA ESTADISTICAS ================= */

function renderStats(){
if(!currentTest)return;
let agrupado={};
currentTest.results.forEach(r=>{
if(!agrupado[r.athlete])agrupado[r.athlete]=[];
agrupado[r.athlete].push(r.time);
});

let html="<table><tr><th>Atleta</th><th>Intentos</th><th>Mejor</th><th>Peor</th><th>Promedio</th></tr>";

for(let atleta in agrupado){
let tiempos=agrupado[atleta];
let promedio=tiempos.reduce((a,b)=>a+b)/tiempos.length;
html+=`<tr>
<td>${atleta}</td>
<td>${tiempos.length}</td>
<td>${Math.min(...tiempos).toFixed(3)}</td>
<td>${Math.max(...tiempos).toFixed(3)}</td>
<td>${promedio.toFixed(3)}</td>
</tr>`;
}

html+="</table>";
statsTable.innerHTML=html;
}

/* ================= GRAFICO ================= */

function renderGraph(){
let atleta=graphAthleteSelect.value;
let tiempos=[];

allTests.forEach(t=>{
t.results.forEach(r=>{
if(r.athlete===atleta)tiempos.push(r.time);
});
});

if(chart)chart.destroy();

chart=new Chart(document.getElementById("progressChart"),{
type:"line",
data:{
labels:tiempos.map((_,i)=>"Intento "+(i+1)),
datasets:[{
label:"Progreso de tiempos",
data:tiempos,
borderColor:"lime",
backgroundColor:"rgba(0,255,0,0.2)"
}]
}
});
}

function renderAll(){
renderAthletes();
}

</script>
</body>
</html>
