<script>

/* ================= BASE ================= */

function safeParse(key){
try{return JSON.parse(localStorage.getItem(key))||[];}
catch{return [];}
}

let athletes=safeParse("athletes");
let allTests=safeParse("allTests");
let currentTest=null;
let chartInstance=null;

function login(){
loginCard.classList.add("hidden");
app.classList.remove("hidden");
renderAll();
}

function logout(){location.reload();}

function showTab(tab){
mainTab.classList.add("hidden");
statsTab.classList.add("hidden");
document.getElementById(tab).classList.remove("hidden");
}

/* ================= ATLETAS ================= */

function createAthlete(){
athletes.push({
user:newAthleteUser.value,
pass:newAthletePass.value,
age:newAthleteAge.value,
sex:newAthleteSex.value
});
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

function deleteAthlete(index){
if(confirm("¿Eliminar atleta?")){
athletes.splice(index,1);
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}
}

function editAthlete(index){
let a=athletes[index];
let nuevo=prompt("Nuevo nombre:",a.user);
if(nuevo){
athletes[index].user=nuevo;
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}
}

function renderAthletes(){
athleteList.innerHTML="";
downloadAthleteSelect.innerHTML="";
statsAthleteSelect.innerHTML="";

athletes.forEach((a,i)=>{
athleteList.innerHTML+=`
${a.user} | Edad:${a.age||"-"} | Sexo:${a.sex||"-"}
<button class="small-btn btn-edit" onclick="editAthlete(${i})">Editar</button>
<button class="small-btn btn-danger" onclick="deleteAthlete(${i})">Eliminar</button>
<hr>`;
downloadAthleteSelect.innerHTML+=`<option value="${a.user}">${a.user}</option>`;
statsAthleteSelect.innerHTML+=`<option value="${a.user}">${a.user}</option>`;
});
}

/* ================= PRUEBAS ================= */

function activateTest(){
currentTest={
name:testName.value,
distance:testDistance.value,
date:testDate.value,
results:[]
};
allTests.push(currentTest);
localStorage.setItem("allTests",JSON.stringify(allTests));
activeTestInfo.innerHTML=`Activa: ${currentTest.name}`;
renderTests();
}

/* ================= CRONOMETRO ================= */

let laneTimers={},results=[],startTime=0,interval;

function startCompetition(){
lanes.innerHTML="";
laneTimers={};
results=[];
clearInterval(interval);
startTime=0;

for(let i=1;i<=laneCount.value;i++){
laneTimers[i]={finished:false,time:0,athlete:null};
let options=athletes.map(a=>`<option>${a.user}</option>`).join("");
lanes.innerHTML+=`
<div class="lane">
Carril ${i}
<select onchange="laneTimers[${i}].athlete=this.value">
<option></option>${options}
</select>
<div class="timeDisplay" id="time${i}">0.000</div>
<button onclick="finishLane(${i})">TOCAR</button>
</div>`;
}
}

function startRaceNow(){
if(Object.keys(laneTimers).length===0) return;

startTime=Date.now();
clearInterval(interval);

interval=setInterval(()=>{
let t=Date.now()-startTime;
for(let i in laneTimers){
if(!laneTimers[i].finished){
laneTimers[i].time=t;
document.getElementById("time"+i).innerText=(t/1000).toFixed(3);
}
}
},10);
}

function finishLane(i){

// No permitir tocar si no inició
if(!startTime) return;

// Ya terminó ese carril
if(!laneTimers[i] || laneTimers[i].finished) return;

laneTimers[i].finished=true;

let final=laneTimers[i].time/1000;
let name=laneTimers[i].athlete||"Sin atleta";

results.push({name,time:final});

// Guardar en prueba activa
if(currentTest){
currentTest.results.push({athlete:name,time:final});
localStorage.setItem("allTests",JSON.stringify(allTests));
}

renderRanking();

// Si todos terminaron, parar cronómetro
let allFinished=Object.values(laneTimers).every(l=>l.finished);
if(allFinished){
clearInterval(interval);
}
}

function resetRace(){
clearInterval(interval);
startTime=0;
results=[];
ranking.innerHTML="";

for(let i in laneTimers){
laneTimers[i].finished=false;
laneTimers[i].time=0;
document.getElementById("time"+i).innerText="0.000";
}
}

/* ================= RANKING ================= */

function renderRanking(){
ranking.innerHTML="";
results.sort((a,b)=>a.time-b.time);
results.forEach((r,i)=>{
ranking.innerHTML+=`${i+1}° ${r.name} - ${r.time.toFixed(3)}s<br>`;
});
}

/* ================= GRAFICO ================= */

function renderChart(){
let athlete=statsAthleteSelect.value;
let tiempos=[];
let etiquetas=[];

allTests.forEach(t=>{
t.results.forEach(r=>{
if(r.athlete===athlete){
tiempos.push(r.time);
etiquetas.push(t.name+" "+t.date);
}
});
});

if(chartInstance) chartInstance.destroy();

chartInstance=new Chart(progressChart,{
type:'line',
data:{
labels:etiquetas,
datasets:[{
label:'Progreso',
data:tiempos,
borderColor:'blue',
backgroundColor:'lightblue'
}]
}
});
}

function renderTests(){
downloadTestSelect.innerHTML="";
allTests.forEach((t,i)=>{
downloadTestSelect.innerHTML+=`<option value="${i}">${t.name} - ${t.date}</option>`;
});
}

function renderAll(){
renderAthletes();
renderTests();
}

</script>
