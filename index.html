<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO MAX</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:white}
.lane{background:#111827;padding:15px;margin:10px 0;border-radius:15px;text-align:center;}
.timeDisplay{font-size:22px;font-weight:bold;margin:10px 0;}
.hidden{display:none}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
.small-btn{padding:5px;font-size:12px;margin-top:5px;width:auto;margin-right:5px;}
</style>
</head>
<body>

<h2>游끩 Sistema Competencia Elite PRO MAX</h2>

<div id="loginCard" class="card">
<h3>Iniciar Sesi칩n</h3>
<input type="text" id="loginUser" placeholder="Usuario">
<input type="password" id="loginPass" placeholder="Contrase침a">
<button class="btn" onclick="login()">Ingresar</button>
</div>

<div id="app" class="hidden">

<button class="btn-danger" onclick="logout()">Cerrar Sesi칩n</button>

<div class="card">
<h3>Entrenadores</h3>
<input type="text" id="newCoachName" placeholder="Nombre del Entrenador">
<input type="file" id="newCoachFirma" accept="image/*">
<button class="btn-success" onclick="createCoach()">Crear Entrenador</button>
<select id="coachSelect"></select>
</div>

<div class="card">
<h3>游닌 Descargas Profesionales (PDF)</h3>
<input type="file" id="logoInput" accept="image/*">
<label>Logo Institucional</label>
<button class="btn" onclick="downloadFull()">Descargar Historial Completo</button>
<select id="downloadTestSelect"></select>
<button class="btn-danger" onclick="downloadByTest()">Descargar por Prueba</button>
</div>

</div>

<script>

/* ===== BASE ===== */
function safeParse(key){
try{return JSON.parse(localStorage.getItem(key))||[];}
catch{return [];}
}

let allTests=safeParse("allTests");
let coaches=safeParse("coaches");

/* ===== LOGIN ===== */
function login(){
document.getElementById("loginCard").classList.add("hidden");
document.getElementById("app").classList.remove("hidden");
renderAll();
}
function logout(){location.reload();}

/* ===== ENTRENADORES ===== */
function createCoach(){
let nombre=document.getElementById("newCoachName").value;
let firmaFile=document.getElementById("newCoachFirma").files[0];

if(!nombre) return alert("Ingrese nombre del entrenador");

if(coaches.some(c=>c.name===nombre)){
alert("Ya existe ese entrenador");
return;
}

if(firmaFile){
let reader=new FileReader();
reader.onload=function(){
coaches.push({name:nombre,firma:reader.result});
localStorage.setItem("coaches",JSON.stringify(coaches));
renderCoaches();
}
reader.readAsDataURL(firmaFile);
}else{
coaches.push({name:nombre,firma:null});
localStorage.setItem("coaches",JSON.stringify(coaches));
renderCoaches();
}
}

function renderCoaches(){
coachSelect.innerHTML="";
coaches.forEach((c,i)=>{
coachSelect.innerHTML+=`<option value="${i}">${c.name}</option>`;
});
}

/* ===== PRUEBAS DEMO SI NO HAY ===== */
if(allTests.length===0){
allTests.push({
name:"100m Libre",
distance:100,
date:"2026-02-25",
results:[
{athlete:"Juan",time:55.321},
{athlete:"Pedro",time:57.112}
]
});
localStorage.setItem("allTests",JSON.stringify(allTests));
}

/* ===== TEXTO REPORTE ===== */
function generarTexto(test){

let texto=`PRUEBA: ${test.name}\n`;
texto+=`Distancia: ${test.distance} m\n`;
texto+=`Fecha: ${test.date}\n\n`;

test.results.forEach(r=>{
texto+=`${r.athlete} - ${r.time.toFixed(3)} s\n`;
});

texto+="\n----------------------------------------\n\n";
return texto;
}

/* ===== PDF PROFESIONAL ===== */
async function generarPDF(texto,nombreArchivo){

const { jsPDF } = window.jspdf;
const doc = new jsPDF();

let pageWidth = doc.internal.pageSize.getWidth();
let pageHeight = doc.internal.pageSize.getHeight();
let y=20;

/* FECHA Y HORA */
let now=new Date();
let fecha=now.toLocaleDateString();
let hora=now.toLocaleTimeString();

/* LOGO */
let logo=document.getElementById("logoInput").files[0];
if(logo){
let base=await fileToBase64(logo);
doc.addImage(base,"PNG",15,10,40,20);
}

doc.setFontSize(14);
doc.text("REPORTE OFICIAL",pageWidth/2,25,null,null,"center");

doc.setFontSize(9);
doc.text(`Generado el: ${fecha} ${hora}`,pageWidth-15,15,null,null,"right");

y=40;

/* CONTENIDO */
let lines=doc.splitTextToSize(texto,180);

lines.forEach(l=>{
if(y>pageHeight-20){
doc.addPage();
y=20;
}
doc.text(l,15,y);
y+=6;
});

/* ENTRENADOR SOLO 칔LTIMA P츼GINA */
let totalPages=doc.getNumberOfPages();
doc.setPage(totalPages);

let coachIndex=document.getElementById("coachSelect").value;
let coach=coaches[coachIndex];

let finalY=pageHeight-40;

doc.setFontSize(10);
doc.line(20,finalY,100,finalY);

if(coach){
doc.text(`Entrenador: ${coach.name}`,20,finalY+8);
if(coach.firma){
doc.addImage(coach.firma,"PNG",20,finalY-25,60,20);
}
}

/* NUMERACI칍N */
for(let i=1;i<=totalPages;i++){
doc.setPage(i);
doc.setFontSize(9);
doc.text(`P치gina ${i} de ${totalPages}`,pageWidth-15,pageHeight-10,null,null,"right");
}

doc.save(nombreArchivo+".pdf");
}

function fileToBase64(file){
return new Promise((res,rej)=>{
let reader=new FileReader();
reader.readAsDataURL(file);
reader.onload=()=>res(reader.result);
reader.onerror=error=>rej(error);
});
}

/* ===== DESCARGAS ===== */
function downloadFull(){
let texto="";
allTests.forEach(t=>texto+=generarTexto(t)+"\n");
generarPDF(texto,"historial_completo");
}

function downloadByTest(){
let index=downloadTestSelect.value;
let test=allTests[index];
if(!test) return alert("Seleccione prueba");
generarPDF(generarTexto(test),"historial_"+test.name);
}

function renderTests(){
downloadTestSelect.innerHTML="";
allTests.forEach((t,i)=>{
downloadTestSelect.innerHTML+=`<option value="${i}">${t.name} - ${t.date}</option>`;
});
}

function renderAll(){
renderCoaches();
renderTests();
}

</script>
</body>
</html>

