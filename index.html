<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Plataforma Nataci√≥n Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{font-family:Arial;background:#0f172a;color:white;padding:20px}
input,select,button{margin:5px;padding:6px;border-radius:6px;border:none}
button{cursor:pointer}
.btn{background:#2563eb;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:black}
.small-btn{padding:3px 6px;font-size:12px}
.box{background:#1e293b;padding:15px;border-radius:10px;margin-bottom:20px}
</style>
</head>
<body>

<h1>üèä Plataforma Entrenador Nataci√≥n</h1>

<!-- ENTRENADOR -->
<div class="box">
<h3>Entrenador</h3>
<input type="text" id="coachName" placeholder="Nombre del Entrenador">
<button class="btn" onclick="saveCoach()">Guardar Entrenador</button>
<p id="coachDisplay"></p>
</div>

<!-- ATLETAS -->
<div class="box">
<h3>Agregar Atleta</h3>
<input type="text" id="athleteName" placeholder="Nombre">
<input type="number" id="athleteAge" placeholder="Edad">
<select id="athleteSex">
<option value="">Sexo</option>
<option>Masculino</option>
<option>Femenino</option>
</select>
<button class="btn" onclick="addAthlete()">Agregar</button>
<div id="athleteList"></div>
</div>

<!-- PRUEBAS -->
<div class="box">
<h3>Crear Prueba</h3>
<input type="text" id="testName" placeholder="Nombre Prueba">
<input type="number" id="testDistance" placeholder="Distancia (m)">
<input type="date" id="testDate">
<button class="btn" onclick="createTest()">Crear</button>
</div>

<!-- REGISTRO -->
<div class="box">
<h3>Registrar Tiempo</h3>
<select id="testSelect"></select>
<select id="athleteSelect"></select>
<input type="number" id="timeInput" step="0.001" placeholder="Tiempo en segundos">
<button class="btn" onclick="addResult()">Registrar</button>
</div>

<!-- DESCARGA -->
<div class="box">
<h3>Descargar PDF</h3>

<select id="filterAthlete">
<option value="">Todos los atletas</option>
</select>

<input type="date" id="downloadDate">

<button class="btn-warning" onclick="downloadByFilter()">Descargar Reporte</button>
</div>

<script>

let athletes=[]
let allTests=[]
let coach=""

function saveData(){
localStorage.setItem("athletes",JSON.stringify(athletes))
localStorage.setItem("tests",JSON.stringify(allTests))
localStorage.setItem("coach",coach)
}

function loadData(){
athletes=JSON.parse(localStorage.getItem("athletes"))||[]
allTests=JSON.parse(localStorage.getItem("tests"))||[]
coach=localStorage.getItem("coach")||""
document.getElementById("coachDisplay").innerText=coach? "Entrenador: "+coach:""
renderAthletes()
renderTests()
}

function saveCoach(){
coach=document.getElementById("coachName").value
saveData()
document.getElementById("coachDisplay").innerText="Entrenador: "+coach
}

function addAthlete(){
let name=document.getElementById("athleteName").value.trim()
let age=document.getElementById("athleteAge").value
let sex=document.getElementById("athleteSex").value

if(!name)return alert("Nombre requerido")
if(athletes.some(a=>a.user===name))return alert("Ya existe")

athletes.push({user:name,age,sex})
saveData()
renderAthletes()
}

function renderAthletes(){
document.getElementById("athleteList").innerHTML=""
document.getElementById("athleteSelect").innerHTML=""
document.getElementById("filterAthlete").innerHTML="<option value=''>Todos los atletas</option>"

athletes.forEach((a,i)=>{
document.getElementById("athleteList").innerHTML+=`
<div>
${a.user}
<button class="small-btn btn-danger" onclick="deleteAthlete(${i})">Eliminar</button>
</div>`

document.getElementById("athleteSelect").innerHTML+=`<option>${a.user}</option>`
document.getElementById("filterAthlete").innerHTML+=`<option>${a.user}</option>`
})
}

function deleteAthlete(i){
if(confirm("Eliminar atleta?")){
athletes.splice(i,1)
saveData()
renderAthletes()
}
}

function createTest(){
let name=document.getElementById("testName").value
let distance=document.getElementById("testDistance").value
let date=document.getElementById("testDate").value

if(!name||!date)return alert("Faltan datos")

allTests.push({name,distance,date,results:[]})
saveData()
renderTests()
}

function renderTests(){
document.getElementById("testSelect").innerHTML=""
allTests.forEach((t,i)=>{
document.getElementById("testSelect").innerHTML+=`<option value="${i}">${t.name} - ${t.date}</option>`
})
}

function addResult(){
let testIndex=document.getElementById("testSelect").value
let athlete=document.getElementById("athleteSelect").value
let time=parseFloat(document.getElementById("timeInput").value)

if(!athlete||!time)return alert("Datos inv√°lidos")

allTests[testIndex].results.push({athlete,time})
saveData()
alert("Tiempo registrado")
}

function generarTextoFiltrado(atletaFiltro,fechaFiltro){

let texto="REPORTE DE RENDIMIENTO\n\n"
texto+="Entrenador: "+(coach||"No definido")+"\n\n"

let historialGlobal=[]

allTests
.sort((a,b)=>new Date(a.date)-new Date(b.date))
.forEach(test=>{

if(fechaFiltro && test.date!==fechaFiltro)return

let resultados=test.results.filter(r=>{
if(atletaFiltro)return r.athlete===atletaFiltro
return true
})

if(resultados.length===0)return

texto+=`PRUEBA: ${test.name}\n`
texto+=`Distancia: ${test.distance} m\n`
texto+=`Fecha: ${test.date}\n\n`

let agrupado={}
resultados.forEach(r=>{
if(!agrupado[r.athlete])agrupado[r.athlete]=[]
agrupado[r.athlete].push(r.time)
})

for(let atleta in agrupado){

let tiempos=agrupado[atleta]
let intentos=tiempos.length
let mejor=Math.min(...tiempos)
let promedio=tiempos.reduce((a,b)=>a+b,0)/intentos

historialGlobal.push(...tiempos)

let info=athletes.find(a=>a.user===atleta)||{}

texto+=`Atleta: ${atleta}\n`
texto+=`Edad: ${info.age||"-"}\n`
texto+=`Sexo: ${info.sex||"-"}\n`
texto+=`Intentos: ${intentos}\n`
texto+=`Tiempos: ${tiempos.map(t=>t.toFixed(3)).join(" - ")}\n`
texto+=`Mejor Tiempo: ${mejor.toFixed(3)}\n`
texto+=`Promedio: ${promedio.toFixed(3)}\n`
texto+="-------------------------\n\n"
}

})

if(historialGlobal.length>=2){
let primero=historialGlobal[0]
let ultimo=historialGlobal[historialGlobal.length-1]
let mejora=((primero-ultimo)/primero)*100
texto+="MEJORA HIST√ìRICA GLOBAL: "+mejora.toFixed(2)+" %\n"
}

return texto
}

function downloadByFilter(){

let atleta=document.getElementById("filterAthlete").value
let fecha=document.getElementById("downloadDate").value

let texto=generarTextoFiltrado(atleta,fecha)

if(!texto)return alert("Sin datos")

const {jsPDF}=window.jspdf
let doc=new jsPDF()
doc.text(texto,10,10)
doc.save("reporte.pdf")
}

loadData()

</script>
</body>
</html>
