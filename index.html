<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO MAX</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:white}
.lane{background:#111827;padding:15px;margin:10px 0;border-radius:15px;text-align:center;}
.timeDisplay{font-size:22px;font-weight:bold;margin:10px 0;}
.hidden{display:none}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
.small-btn{padding:5px;font-size:12px;margin-top:5px;width:auto;margin-right:5px;}
.roleTag{background:#2563eb;padding:5px 10px;border-radius:10px;font-size:12px;display:inline-block;margin-bottom:10px;}
</style>
</head>
<body>

<h2>游끩 Sistema Competencia Elite PRO MAX</h2>

<div id="loginCard" class="card">
<h3>Iniciar Sesi칩n</h3>
<input type="text" id="loginUser" placeholder="Usuario">
<input type="password" id="loginPass" placeholder="Contrase침a">
<button class="btn" onclick="login()">Ingresar</button>
</div>

<div id="app" class="hidden">

<div id="sessionInfo"></div>
<button class="btn-danger" onclick="logout()">Cerrar Sesi칩n</button>

<div id="coachCard" class="card hidden">
<h3>Entrenadores</h3>

<input type="text" id="newCoachName" placeholder="Usuario entrenador">
<input type="password" id="newCoachPass" placeholder="Contrase침a">
<input type="text" id="newCoachSpecialty" placeholder="Especialidad">
<button class="btn-success" onclick="createCoach()">Crear Entrenador</button>

<div id="coachList"></div>
</div>

<div class="card">
<h3>游늶 Datos de la Prueba</h3>
<input type="text" id="testName" placeholder="Nombre prueba">
<input type="number" id="testDistance" placeholder="Metros">
<input type="date" id="testDate">
<button class="btn-success" onclick="activateTest()">Activar Prueba</button>
<div id="activeTestInfo"></div>
</div>

<div class="card">
<h3>Competencia</h3>
<input type="number" id="laneCount" value="4" min="2" max="10">
<button class="btn-success" onclick="startCompetition()">Crear Carriles</button>
<button class="btn-success" onclick="startRaceNow()">游뚽 INICIAR</button>
<button class="btn-danger" onclick="resetRace()">游댃 Reiniciar</button>
<div id="lanes"></div>
</div>

<div class="card">
<h3>Ranking</h3>
<div id="ranking"></div>
</div>

<div class="card">
<h3>游닌 Descargar PDF</h3>
<button class="btn" onclick="downloadCurrentTest()">Descargar Prueba Actual</button>
</div>

</div>

<script>

/* ===== UTIL ===== */
function safeParse(key){
try{return JSON.parse(localStorage.getItem(key))||[];}
catch{return [];}
}

/* ===== VARIABLES ===== */
let coaches = safeParse("coaches");
let allTests = safeParse("allTests");
let currentTest = null;
let loggedUser = null;

/* ===== CREAR ADMIN SI NO EXISTE ===== */
if(!coaches.some(c => c.role === "admin")){
coaches.push({
user:"admin",
pass:"admin123",
role:"admin",
specialty:"Administrador"
});
localStorage.setItem("coaches",JSON.stringify(coaches));
}

/* ===== LOGIN ===== */
function login(){
let user=document.getElementById("loginUser").value;
let pass=document.getElementById("loginPass").value;

let found=coaches.find(c=>c.user===user && c.pass===pass);

if(!found){
alert("Credenciales incorrectas");
return;
}

loggedUser=found;

document.getElementById("loginCard").classList.add("hidden");
document.getElementById("app").classList.remove("hidden");

document.getElementById("sessionInfo").innerHTML=
`<div class="roleTag">Usuario: ${found.user} | Rol: ${found.role}</div>`;

if(found.role==="admin"){
document.getElementById("coachCard").classList.remove("hidden");
renderCoaches();
}
}

/* ===== LOGOUT ===== */
function logout(){
location.reload();
}

/* ===== ENTRENADORES ===== */
function createCoach(){
if(loggedUser.role!=="admin") return;

let name=document.getElementById("newCoachName").value;
let pass=document.getElementById("newCoachPass").value;
let spec=document.getElementById("newCoachSpecialty").value;

if(!name || !pass){
alert("Complete usuario y contrase침a");
return;
}

if(coaches.some(c=>c.user===name)){
alert("Ya existe entrenador");
return;
}

coaches.push({
user:name,
pass:pass,
role:"coach",
specialty:spec||""
});

localStorage.setItem("coaches",JSON.stringify(coaches));
renderCoaches();

newCoachName.value="";
newCoachPass.value="";
newCoachSpecialty.value="";
}

function editCoach(index){
if(loggedUser.role!=="admin") return;

let nuevo=prompt("Nuevo usuario:",coaches[index].user);
if(!nuevo) return;

coaches[index].user=nuevo;
localStorage.setItem("coaches",JSON.stringify(coaches));
renderCoaches();
}

function deleteCoach(index){
if(loggedUser.role!=="admin") return;
if(!confirm("쮼liminar entrenador?")) return;

coaches.splice(index,1);
localStorage.setItem("coaches",JSON.stringify(coaches));
renderCoaches();
}

function renderCoaches(){
let container=document.getElementById("coachList");
container.innerHTML="";

coaches.forEach((c,i)=>{
if(c.role==="admin") return;
container.innerHTML+=`
<div style="background:#111827;padding:5px;margin-bottom:5px;border-radius:8px;">
<b>${c.user}</b> - ${c.specialty}
<br>
<button class="small-btn btn-warning" onclick="editCoach(${i})">Editar</button>
<button class="small-btn btn-danger" onclick="deleteCoach(${i})">Eliminar</button>
</div>`;
});
}

/* ===== PRUEBA ===== */
function activateTest(){
let name=testName.value;
let date=testDate.value;
if(!name || !date){
alert("Complete nombre y fecha");
return;
}

currentTest={
name:name,
distance:testDistance.value,
date:date,
coach:loggedUser.user,
results:[]
};

allTests.push(currentTest);
localStorage.setItem("allTests",JSON.stringify(allTests));

activeTestInfo.innerHTML=
`Activa: ${name} | Entrenador: ${loggedUser.user}`;
}

/* ===== CRONOMETRO ===== */
let laneTimers={},results=[],interval;

function startCompetition(){
lanes.innerHTML="";
laneTimers={};
results=[];

for(let i=1;i<=laneCount.value;i++){
laneTimers[i]={finished:false,time:0};

lanes.innerHTML+=`
<div class="lane">
Carril ${i}
<div class="timeDisplay" id="time${i}">0.000</div>
<button onclick="finishLane(${i})">TOCAR</button>
</div>`;
}
}

function startRaceNow(){
let startTime=Date.now();
clearInterval(interval);

interval=setInterval(()=>{
let t=Date.now()-startTime;

for(let i in laneTimers){
if(!laneTimers[i].finished){
laneTimers[i].time=t;
document.getElementById("time"+i).innerText=(t/1000).toFixed(3);
}
}
},10);
}

function resetRace(){
clearInterval(interval);
ranking.innerHTML="";
for(let i in laneTimers){
laneTimers[i].finished=false;
laneTimers[i].time=0;
let el=document.getElementById("time"+i);
if(el) el.innerText="0.000";
}
}

function finishLane(i){
if(laneTimers[i].finished) return;

laneTimers[i].finished=true;
let final=laneTimers[i].time/1000;

results.push({lane:i,time:final});

if(currentTest){
currentTest.results.push({lane:i,time:final});
localStorage.setItem("allTests",JSON.stringify(allTests));
}

renderRanking();
}

function renderRanking(){
ranking.innerHTML="";
results.sort((a,b)=>a.time-b.time);
results.forEach((r,i)=>{
ranking.innerHTML+=`${i+1}춿 Carril ${r.lane} - ${r.time.toFixed(3)}s<br>`;
});
}

/* ===== PDF ===== */
async function downloadCurrentTest(){
if(!currentTest){
alert("No hay prueba activa");
return;
}

const { jsPDF } = window.jspdf;
const doc = new jsPDF();

doc.setFontSize(14);
doc.text("REPORTE OFICIAL",105,20,null,null,"center");

doc.setFontSize(11);
doc.text(`Prueba: ${currentTest.name}`,20,40);
doc.text(`Distancia: ${currentTest.distance} m`,20,50);
doc.text(`Fecha: ${currentTest.date}`,20,60);
doc.text(`Entrenador: ${currentTest.coach}`,20,70);

let y=90;
currentTest.results.forEach((r,i)=>{
doc.text(`${i+1}춿 Carril ${r.lane} - ${r.time.toFixed(3)} s`,20,y);
y+=8;
});

doc.text("Firma Entrenador:",20,y+20);
doc.text(currentTest.coach,20,y+30);

doc.save("reporte_"+currentTest.name+".pdf");
}

</script>
</body>
</html>
