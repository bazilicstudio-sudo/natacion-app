<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Plataforma Nataci칩n Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{font-family:Arial;background:#0f172a;color:white;padding:20px}
input,select,button{margin:5px;padding:6px;border-radius:6px;border:none}
button{cursor:pointer}
.btn{background:#2563eb;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:black}
.small-btn{padding:3px 6px;font-size:12px}
.box{background:#1e293b;padding:15px;border-radius:10px;margin-bottom:20px}
</style>
</head>
<body>

<h1>游끩 Plataforma Entrenador Nataci칩n</h1>

<div class="box">
<h3>Agregar Atleta</h3>
<input type="text" id="athleteName" placeholder="Nombre">
<input type="number" id="athleteAge" placeholder="Edad">
<select id="athleteSex">
<option value="">Sexo</option>
<option>Masculino</option>
<option>Femenino</option>
</select>
<button class="btn" onclick="addAthlete()">Agregar</button>
<div id="athleteList"></div>
</div>

<div class="box">
<h3>Crear Prueba</h3>
<input type="text" id="testName" placeholder="Nombre Prueba">
<input type="number" id="testDistance" placeholder="Distancia (m)">
<input type="date" id="testDate">
<button class="btn" onclick="createTest()">Crear</button>
</div>

<div class="box">
<h3>Registrar Tiempo</h3>
<select id="testSelect"></select>
<select id="athleteSelect"></select>
<input type="number" id="timeInput" step="0.001" placeholder="Tiempo en segundos">
<button class="btn" onclick="addResult()">Registrar</button>
</div>

<div class="box">
<h3>游닌 Descarga PDF</h3>

<input type="file" id="logoInput" accept="image/*">
<label>Logo</label><br>

<input type="file" id="firmaInput" accept="image/*">
<label>Firma</label><br>

<input type="text" id="coachName" placeholder="Nombre Entrenador"><br>

<select id="filterAthlete">
<option value="">Todos los atletas</option>
</select>

<input type="date" id="downloadDate"><br>

<button class="btn-warning" onclick="downloadByFilter()">Descargar Filtrado</button>
<button class="btn" onclick="downloadFull()">Descargar Completo</button>
</div>

<script>

let athletes=[]
let allTests=[]

function saveData(){
localStorage.setItem("athletes",JSON.stringify(athletes))
localStorage.setItem("tests",JSON.stringify(allTests))
}

function loadData(){
athletes=JSON.parse(localStorage.getItem("athletes"))||[]
allTests=JSON.parse(localStorage.getItem("tests"))||[]
renderAthletes()
renderTests()
}

function addAthlete(){
let name=document.getElementById("athleteName").value.trim()
let age=document.getElementById("athleteAge").value
let sex=document.getElementById("athleteSex").value

if(!name){alert("Nombre requerido");return}
if(athletes.some(a=>a.user===name)){alert("Ya existe");return}

athletes.push({user:name,age,sex})
saveData()
renderAthletes()
}

function renderAthletes(){
document.getElementById("athleteList").innerHTML=""
document.getElementById("athleteSelect").innerHTML=""
document.getElementById("filterAthlete").innerHTML="<option value=''>Todos los atletas</option>"

athletes.forEach((a,i)=>{
document.getElementById("athleteList").innerHTML+=`
<div>
${a.user}
<button class="small-btn btn-warning" onclick="editAthlete(${i})">Editar</button>
<button class="small-btn btn-danger" onclick="deleteAthlete(${i})">Eliminar</button>
</div>`

document.getElementById("athleteSelect").innerHTML+=`<option>${a.user}</option>`
document.getElementById("filterAthlete").innerHTML+=`<option>${a.user}</option>`
})
}

function editAthlete(i){
let nuevo=prompt("Nuevo nombre",athletes[i].user)
if(!nuevo)return
athletes[i].user=nuevo
saveData()
renderAthletes()
}

function deleteAthlete(i){
if(confirm("Eliminar atleta?")){
athletes.splice(i,1)
saveData()
renderAthletes()
}
}

function createTest(){
let name=document.getElementById("testName").value
let distance=document.getElementById("testDistance").value
let date=document.getElementById("testDate").value

if(!name||!date){alert("Faltan datos");return}

allTests.push({name,distance,date,results:[]})
saveData()
renderTests()
}

function renderTests(){
document.getElementById("testSelect").innerHTML=""
allTests.forEach((t,i)=>{
document.getElementById("testSelect").innerHTML+=`<option value="${i}">${t.name} - ${t.date}</option>`
})
}

function addResult(){
let testIndex=document.getElementById("testSelect").value
let athlete=document.getElementById("athleteSelect").value
let time=parseFloat(document.getElementById("timeInput").value)

if(!athlete||!time){alert("Datos inv치lidos");return}

allTests[testIndex].results.push({athlete,time})
saveData()
alert("Tiempo registrado")
}

function generarTexto(test){

let texto=`PRUEBA: ${test.name}\nFecha: ${test.date}\n\n`
let agrupado={}

test.results.forEach(r=>{
if(!agrupado[r.athlete])agrupado[r.athlete]=[]
agrupado[r.athlete].push(r.time)
})

for(let atleta in agrupado){

let tiempos=agrupado[atleta]
let intentos=tiempos.length
let mejor=Math.min(...tiempos)
let promedio=tiempos.reduce((a,b)=>a+b,0)/intentos

let historial=[]
allTests.forEach(t=>{
t.results.forEach(r=>{
if(r.athlete===atleta)historial.push(r.time)
})
})

let mejora="No aplica"
if(historial.length>=2){
let primero=historial[0]
let ultimo=historial[historial.length-1]
let porcentaje=((primero-ultimo)/primero)*100
mejora=porcentaje.toFixed(2)+" %"
}

texto+=`
ATLETA: ${atleta}
Intentos: ${intentos}
Tiempos: ${tiempos.map(t=>t.toFixed(3)).join(" - ")}
Mejor: ${mejor.toFixed(3)}
Promedio: ${promedio.toFixed(3)}
Mejora Hist칩rica: ${mejora}
--------------------------
`
}

return texto
}

async function generarPDF(texto,nombre){

const {jsPDF}=window.jspdf
let doc=new jsPDF()

let y=10

let logo=document.getElementById("logoInput").files[0]
if(logo){
let reader=new FileReader()
reader.onload=function(e){
doc.addImage(e.target.result,"PNG",10,10,30,30)
}
reader.readAsDataURL(logo)
}

doc.text(texto,10,50)

let firma=document.getElementById("firmaInput").files[0]
if(firma){
let reader=new FileReader()
reader.onload=function(e){
doc.addImage(e.target.result,"PNG",140,250,40,20)
doc.save(nombre+".pdf")
}
reader.readAsDataURL(firma)
}else{
doc.save(nombre+".pdf")
}
}

function downloadByFilter(){

let atleta=document.getElementById("filterAthlete").value
let fecha=document.getElementById("downloadDate").value
let texto=""

allTests.forEach(test=>{

if(fecha && test.date!==fecha)return

let resultados=test.results

if(atleta){
resultados=resultados.filter(r=>r.athlete===atleta)
}

if(resultados.length===0)return

let copia={...test,results:resultados}
texto+=generarTexto(copia)
})

if(!texto){alert("Sin datos");return}

generarPDF(texto,"reporte_filtrado")
}

function downloadFull(){

let texto=""
allTests.forEach(t=>{
texto+=generarTexto(t)
})

if(!texto){alert("Sin datos");return}

generarPDF(texto,"reporte_completo")
}

loadData()

</script>
</body>
</html>
