<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO MAX</title>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:white}
.lane{background:#111827;padding:15px;margin:10px 0;border-radius:15px;text-align:center;}
.timeDisplay{font-size:22px;font-weight:bold;margin:10px 0;}
.hidden{display:none}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
.ranking{background:#0b1220;padding:10px;border-radius:10px;margin-top:10px;}
.status{font-weight:bold;margin-top:10px;}
</style>
</head>
<body>

<h2>üèä Sistema Competencia Elite PRO MAX</h2>

<div id="loginCard" class="card">
<button class="btn" onclick="login()">Ingresar</button>
</div>

<div id="app" class="hidden">

<button class="btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>

<div class="card">
<h3>Atletas</h3>
<input type="text" id="newAthleteUser" placeholder="Nombre atleta">
<input type="number" id="newAthleteAge" placeholder="Edad">
<select id="newAthleteSex">
<option value="">Sexo</option>
<option value="Masculino">Masculino</option>
<option value="Femenino">Femenino</option>
</select>
<button class="btn-success" onclick="createAthlete()">Crear Atleta</button>
<div id="athleteList"></div>
</div>

<div class="card">
<h3>üìã Datos de la Prueba</h3>
<input type="text" id="testName" placeholder="Nombre prueba">
<input type="number" id="testDistance" placeholder="Metros">
<input type="date" id="testDate">
<button class="btn-success" onclick="activateTest()">‚úÖ ACTIVAR PRUEBA</button>
<div id="testStatus" class="status"></div>
</div>

<div class="card">
<h3>Competencia</h3>
<input type="number" id="laneCount" value="4" min="2" max="10">
<button class="btn-success" onclick="startCompetition()">Crear Carriles</button>
<button class="btn-success" onclick="startRaceNow()">üö¶ INICIAR</button>
<button class="btn-warning" onclick="pauseRace()">‚è∏ Pausar</button>
<button class="btn-success" onclick="resumeRace()">‚ñ∂ Reanudar</button>
<button class="btn-danger" onclick="resetRace()">üîÑ Reiniciar</button>

<div id="lanes"></div>
<div id="ranking" class="ranking"></div>
</div>

<div class="card">
<h3>üì• Historial</h3>
<select id="historyAthlete"></select>
<button class="btn-success" onclick="downloadAthleteHistory()">Descargar Individual</button>
<button class="btn-warning" onclick="downloadDailyHistory()">Descargar General del D√≠a</button>
</div>

</div>

<script>

/* STORAGE */

function safeParse(key){
try{return JSON.parse(localStorage.getItem(key))||[];}
catch{return [];}
}

let athletes=safeParse("athletes");
let athleteHistory=safeParse("athleteHistory");

/* LOGIN */

function login(){
loginCard.classList.add("hidden");
app.classList.remove("hidden");
renderAll();
}

function logout(){location.reload();}

/* ATLETAS */

function createAthlete(){
if(!newAthleteUser.value)return;

athletes.push({
user:newAthleteUser.value,
age:newAthleteAge.value,
sex:newAthleteSex.value
});

localStorage.setItem("athletes",JSON.stringify(athletes));
renderAll();

newAthleteUser.value="";
newAthleteAge.value="";
newAthleteSex.value="";
}

function renderAll(){
athleteList.innerHTML="";
historyAthlete.innerHTML="";

athletes.forEach(a=>{
athleteList.innerHTML+=`<div><b>${a.user}</b> | Edad:${a.age||"-"} | Sexo:${a.sex||"-"}<hr></div>`;
historyAthlete.innerHTML+=`<option value="${a.user}">${a.user}</option>`;
});
}

/* ACTIVAR PRUEBA */

let testActive=false;

function activateTest(){
if(!testName.value || !testDistance.value || !testDate.value){
alert("Completa todos los datos");
return;
}
testActive=true;
testStatus.innerHTML="üü¢ PRUEBA ACTIVADA";
}

/* CRONOMETRO */

let laneTimers={};
let globalInterval=null;
let raceStarted=false;
let paused=false;
let startTime=0;
let elapsed=0;
let finishedLanes=[];

function startCompetition(){
lanes.innerHTML="";
ranking.innerHTML="";
laneTimers={};
finishedLanes=[];
clearInterval(globalInterval);
raceStarted=false;
paused=false;
elapsed=0;

for(let i=1;i<=laneCount.value;i++){
laneTimers[i]={finished:false,currentTime:0,athlete:null};
let options=athletes.map(a=>`<option value="${a.user}">${a.user}</option>`).join("");

lanes.innerHTML+=`
<div class="lane">
Carril ${i}
<select onchange="laneTimers[${i}].athlete=this.value">
<option value="">Asignar</option>${options}
</select>
<div class="timeDisplay" id="time${i}">0.000</div>
<button onclick="finishLane(${i})">TOCAR</button>
</div>`;
}
}

function startRaceNow(){
if(!testActive){alert("Activa la prueba primero");return;}
if(raceStarted)return;
raceStarted=true;
paused=false;
startTime=Date.now();
globalInterval=setInterval(updateTimers,10);
}

function updateTimers(){
if(!raceStarted)return;
let currentElapsed = paused ? elapsed : elapsed + (Date.now() - startTime);
for(let i in laneTimers){
if(!laneTimers[i].finished){
laneTimers[i].currentTime=currentElapsed;
document.getElementById("time"+i).innerText=(currentElapsed/1000).toFixed(3);
}
}
}

function pauseRace(){
if(!raceStarted||paused)return;
paused=true;
elapsed+=Date.now()-startTime;
}

function resumeRace(){
if(!paused)return;
paused=false;
startTime=Date.now();
}

function resetRace(){
clearInterval(globalInterval);
raceStarted=false;
paused=false;
elapsed=0;
finishedLanes=[];
ranking.innerHTML="";
}

/* FINALIZAR */

function finishLane(lane){
if(laneTimers[lane].finished)return;
laneTimers[lane].finished=true;

let tiempo=laneTimers[lane].currentTime/1000;
let atleta=laneTimers[lane].athlete;

if(atleta){
athleteHistory.push({
athlete:atleta,
distance:testDistance.value,
date:testDate.value,
time:tiempo
});
localStorage.setItem("athleteHistory",JSON.stringify(athleteHistory));

finishedLanes.push({athlete:atleta,time:tiempo});
updateRanking();
}
}

function updateRanking(){
finishedLanes.sort((a,b)=>a.time-b.time);
ranking.innerHTML="<h4>üèÜ Ranking</h4>";
finishedLanes.forEach((r,i)=>{
ranking.innerHTML+=`${i+1}. ${r.athlete} - ${r.time.toFixed(3)}s<br>`;
});
}

/* HISTORIAL INDIVIDUAL */

function downloadAthleteHistory(){

let selected=historyAthlete.value;
if(!selected)return alert("Selecciona atleta");

let filtered=athleteHistory.filter(h=>h.athlete===selected);
if(filtered.length===0)return alert("Sin registros");

let grouped={};

filtered.forEach(r=>{
let key=r.distance+"m";
if(!grouped[key])grouped[key]=[];
grouped[key].push(r);
});

let text=`HISTORIAL INDIVIDUAL\nAtleta: ${selected}\n\n`;

Object.keys(grouped)
.sort((a,b)=>parseInt(a)-parseInt(b))
.forEach(dist=>{

let pruebas=grouped[dist];
pruebas.sort((a,b)=>new Date(a.date)-new Date(b.date));

text+="=================================\n";
text+=`PRUEBA ${dist}\n`;
text+="=================================\n";

let suma=0;

pruebas.forEach(r=>{
suma+=r.time;
text+=`Fecha:${r.date} | Tiempo:${r.time.toFixed(3)}s\n`;
});

text+=`Promedio: ${(suma/pruebas.length).toFixed(3)}s\n\n\n`;
});

downloadFile(text,"historial_individual.txt");
}

/* HISTORIAL GENERAL DEL DIA */

function downloadDailyHistory(){

let fecha=testDate.value;
if(!fecha)return alert("Selecciona fecha de prueba");

let filtered=athleteHistory.filter(h=>h.date===fecha);
if(filtered.length===0)return alert("No hay registros ese d√≠a");

let grouped={};

filtered.forEach(r=>{
let key=r.distance+"m";
if(!grouped[key])grouped[key]=[];
grouped[key].push(r);
});

let text=`HISTORIAL GENERAL DEL DIA ${fecha}\n\n`;

Object.keys(grouped)
.sort((a,b)=>parseInt(a)-parseInt(b))
.forEach(dist=>{

let pruebas=grouped[dist];

text+="=================================\n";
text+=`PRUEBA ${dist}\n`;
text+="=================================\n";

let atletasAgrupados={};

pruebas.forEach(r=>{
if(!atletasAgrupados[r.athlete])atletasAgrupados[r.athlete]=[];
atletasAgrupados[r.athlete].push(r.time);
});

Object.keys(atletasAgrupados)
.sort()
.forEach(nombre=>{

let tiempos=atletasAgrupados[nombre];
let suma=tiempos.reduce((a,b)=>a+b,0);
let promedio=suma/tiempos.length;

text+=`${nombre}\n`;
tiempos.forEach(t=>{
text+=`  Tiempo: ${t.toFixed(3)}s\n`;
});
text+=`  Promedio: ${promedio.toFixed(3)}s\n\n`;
});

text+="\n";
});

downloadFile(text,"historial_general_dia.txt");
}

/* DESCARGA */

function downloadFile(text,name){
let blob=new Blob([text],{type:"text/plain"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download=name;
a.click();
}

</script>
</body>
</html>
