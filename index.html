<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO MAX</title>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:white}
.lane{background:#111827;padding:15px;margin:10px 0;border-radius:15px;text-align:center;}
.timeDisplay{font-size:22px;font-weight:bold;margin:10px 0;}
.hidden{display:none}
input{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
</style>
</head>
<body>

<h2>üèä Sistema Competencia Elite PRO MAX</h2>

<div id="loginCard" class="card">
<h3>Iniciar Sesi√≥n</h3>
<input type="text" id="loginUser" placeholder="Usuario">
<input type="password" id="loginPass" placeholder="Contrase√±a">
<button class="btn" onclick="login()">Ingresar</button>
<button class="btn-warning" onclick="restoreAccess()">Restaurar acceso</button>
</div>

<div id="app" class="hidden">

<button class="btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>

<div class="card">
<h3>üìã Datos de la Prueba</h3>
<input type="text" id="testName" placeholder="Nombre prueba">
<input type="number" id="testDistance" placeholder="Metros">
<input type="date" id="testDate">
<button class="btn-success" onclick="activateTest()">Activar Prueba</button>
<div id="activeTestInfo"></div>
</div>

<div class="card">
<h3>‚è± Tiempo Manual</h3>
<input type="text" id="manualAthlete" placeholder="Nombre atleta">
<input type="number" step="0.001" id="manualTime" placeholder="Tiempo manual en segundos">
<button class="btn-warning" onclick="addManualTime()">Guardar Tiempo Manual</button>
</div>

<div class="card">
<h3>Competencia</h3>
<input type="number" id="laneCount" value="4" min="2" max="10">
<button class="btn-success" onclick="startCompetition()">Crear Carriles</button>
<button class="btn-success" onclick="startRaceNow()">üö¶ INICIAR</button>
<button class="btn-warning" onclick="pauseRace()">‚è∏ Pausar</button>
<button class="btn-success" onclick="resumeRace()">‚ñ∂ Reanudar</button>
<button class="btn-danger" onclick="resetRace()">üîÑ Reiniciar</button>
<div id="lanes"></div>
</div>

<div class="card">
<h3>Resultados</h3>
<div id="ranking"></div>
<button class="btn" onclick="downloadResults()">Descargar Historial</button>
</div>

</div>

<script>

/* ================== BASE SEGURA ================== */

function safeParse(key){
try{return JSON.parse(localStorage.getItem(key))||[];}
catch{return [];}
}

let coaches=safeParse("coaches");
let allTests=safeParse("allTests");
let currentTest=null;

if(!coaches.find(c=>c.user==="admin")){
coaches=[{user:"admin",pass:"1234"}];
localStorage.setItem("coaches",JSON.stringify(coaches));
}

function restoreAccess(){
localStorage.removeItem("coaches");
coaches=[{user:"admin",pass:"1234"}];
localStorage.setItem("coaches",JSON.stringify(coaches));
alert("Usuario: admin | Clave: 1234");
location.reload();
}

function login(){
let coach=coaches.find(c=>c.user===loginUser.value && c.pass===loginPass.value);
if(!coach){alert("Usuario incorrecto");return;}
loginCard.classList.add("hidden");
app.classList.remove("hidden");
}

function logout(){location.reload();}

/* ================== PRUEBAS ================== */

function activateTest(){
if(!testName.value||!testDistance.value||!testDate.value)return;
currentTest={
name:testName.value,
distance:testDistance.value,
date:testDate.value,
results:[]
};
allTests.push(currentTest);
localStorage.setItem("allTests",JSON.stringify(allTests));
activeTestInfo.innerHTML=`Activa: ${currentTest.name} - ${currentTest.distance}m`;
}

/* ================== MANUAL ================== */

function addManualTime(){
if(!currentTest)return alert("Activa una prueba");

let athlete=manualAthlete.value.trim();
let manual=parseFloat(manualTime.value);

if(!athlete)return;

let existing=currentTest.results.find(r=>r.athlete===athlete);

if(existing){
existing.manualTime=manual || 0;
}else{
currentTest.results.push({
athlete:athlete,
chronoTime:0,
manualTime:manual || 0
});
}

localStorage.setItem("allTests",JSON.stringify(allTests));
renderRanking();
}

/* ================== CRONOMETRO PRO ================== */

let laneTimers={};
let globalStartTime=0;
let globalInterval=null;
let raceStarted=false;
let paused=false;
let pausedAt=0;
let totalPausedTime=0;

function startCompetition(){
lanes.innerHTML="";
laneTimers={};
clearInterval(globalInterval);
raceStarted=false;
paused=false;
totalPausedTime=0;

for(let i=1;i<=laneCount.value;i++){
laneTimers[i]={finished:false,currentTime:0,athlete:null};
lanes.innerHTML+=`
<div class="lane">
Carril ${i}
<input placeholder="Nombre atleta" onchange="laneTimers[${i}].athlete=this.value">
<div class="timeDisplay" id="time${i}">0.000</div>
<button onclick="finishLane(${i})">TOCAR</button>
</div>`;
}
}

function startRaceNow(){
if(raceStarted)return;
raceStarted=true;
paused=false;
totalPausedTime=0;
globalStartTime=Date.now();
globalInterval=setInterval(updateTimers,10);
}

function updateTimers(){
if(!raceStarted||paused)return;

let now=Date.now();
let realElapsed=now-globalStartTime-totalPausedTime;

for(let i in laneTimers){
if(!laneTimers[i].finished){
laneTimers[i].currentTime=realElapsed;
document.getElementById("time"+i).innerText=(realElapsed/1000).toFixed(3);
}
}
}

function pauseRace(){
if(!raceStarted||paused)return;
paused=true;
pausedAt=Date.now();
}

function resumeRace(){
if(!raceStarted||!paused)return;
paused=false;
totalPausedTime+=Date.now()-pausedAt;
}

function resetRace(){
clearInterval(globalInterval);
raceStarted=false;
paused=false;
laneTimers={};
lanes.innerHTML="";
}

/* ================== FINALIZAR ================== */

function finishLane(i){
if(!currentTest)return alert("Activa una prueba");
if(laneTimers[i].finished)return;

laneTimers[i].finished=true;

let athlete=laneTimers[i].athlete||"Sin atleta";
let chrono=(laneTimers[i].currentTime/1000)||0;

let existing=currentTest.results.find(r=>r.athlete===athlete);

if(existing){
existing.chronoTime=chrono;
}else{
currentTest.results.push({
athlete:athlete,
chronoTime:chrono,
manualTime:0
});
}

localStorage.setItem("allTests",JSON.stringify(allTests));
renderRanking();
}

/* ================== RANKING ================== */

function renderRanking(){
if(!currentTest)return;
ranking.innerHTML="";
currentTest.results.forEach(r=>{
ranking.innerHTML+=`
${r.athlete} 
| Crono: ${r.chronoTime.toFixed(3)}s 
| Manual: ${r.manualTime.toFixed(3)}s<br>`;
});
}

/* ================== DESCARGA ================== */

function downloadResults(){
let text="";
allTests.forEach(t=>{
text+="====================\n";
text+=`${t.name} - ${t.distance}m - ${t.date}\n\n`;
t.results.forEach(r=>{
text+=`${r.athlete} | Crono: ${r.chronoTime}s | Manual: ${r.manualTime}s\n`;
});
text+="\n";
});
let blob=new Blob([text],{type:"text/plain"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="historial.txt";
a.click();
}

</script>
</body>
</html>


