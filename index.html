<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO</title>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:white}
.lane{background:#111827;padding:15px;margin:10px 0;border-radius:15px;text-align:center;}
.timeDisplay{font-size:22px;font-weight:bold;margin:10px 0;}
.hidden{display:none}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
</style>
</head>
<body>

<h2>üèä Sistema Competencia Elite PRO</h2>

<!-- LOGIN -->
<div id="loginCard" class="card">
<h3>Iniciar Sesi√≥n</h3>
<select id="roleSelect">
<option value="coach">Entrenador</option>
<option value="athlete">Atleta</option>
</select>

<input type="text" id="loginUser" placeholder="Usuario">
<input type="password" id="loginPass" placeholder="Contrase√±a">

<button class="btn" onclick="login()">Ingresar</button>
<button class="btn-success" onclick="registerCoach()">Registrar Nuevo Entrenador</button>
</div>

<div id="app" class="hidden">

<button class="btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>

<!-- PANEL ENTRENADOR -->
<div id="coachPanel" class="hidden">

<div class="card">
<h3>üìã Crear / Activar Prueba</h3>
<input type="text" id="testName" placeholder="Nombre prueba (50m Libre)">
<input type="number" id="testDistance" placeholder="Metros">
<input type="date" id="testDate">
<button class="btn-success" onclick="createTest()">Activar Prueba</button>
<div id="activeTestInfo"></div>
</div>

<div class="card">
<h3>Crear Atleta</h3>
<input type="text" id="newAthlete">
<input type="password" id="newPass">
<button class="btn-success" onclick="createAthlete()">Crear</button>
</div>

<div class="card">
<h3>Competencia</h3>
<input type="number" id="laneCount" value="4">
<button class="btn-success" onclick="startCompetition()">Crear Carriles</button>
<button class="btn-success" onclick="startRace()">INICIAR</button>
<button class="btn-danger" onclick="resetRace()">Reiniciar</button>
<div id="lanes"></div>
</div>

<div class="card">
<h3>Ranking</h3>
<div id="ranking"></div>
<button class="btn" onclick="downloadAll()">Descargar Historial Completo</button>
</div>

</div>

</div>

<script>

let currentUser=null;
let currentRole=null;
let currentTest=null;

let coaches=JSON.parse(localStorage.getItem("coaches")||"[]");
let athletes=JSON.parse(localStorage.getItem("athletes")||"[]");
let allTests=JSON.parse(localStorage.getItem("allTests")||"[]");

let laneTimers={};
let results=[];
let startTime;
let interval;

/* REGISTRAR ENTRENADOR */
function registerCoach(){
if(!loginUser.value || !loginPass.value){alert("Completa datos");return;}
coaches.push({user:loginUser.value,pass:loginPass.value});
localStorage.setItem("coaches",JSON.stringify(coaches));
alert("Entrenador registrado");
}

/* LOGIN */
function login(){
if(roleSelect.value==="coach"){
let coach=coaches.find(c=>c.user===loginUser.value && c.pass===loginPass.value);
if(!coach){alert("No encontrado");return;}
currentRole="coach";
currentUser=coach.user;
coachPanel.classList.remove("hidden");
}
loginCard.classList.add("hidden");
app.classList.remove("hidden");
}

/* LOGOUT */
function logout(){location.reload();}

/* CREAR ATLETA */
function createAthlete(){
athletes.push({user:newAthlete.value,pass:newPass.value});
localStorage.setItem("athletes",JSON.stringify(athletes));
alert("Atleta creado");
}

/* CREAR PRUEBA */
function createTest(){
if(!testName.value || !testDistance.value || !testDate.value){
alert("Completa datos");return;
}

let existing=allTests.find(t=>
t.coach===currentUser &&
t.name===testName.value &&
t.date===testDate.value
);

if(existing){
currentTest=existing;
}else{
currentTest={
coach:currentUser,
name:testName.value,
distance:testDistance.value,
date:testDate.value,
results:[]
};
allTests.push(currentTest);
localStorage.setItem("allTests",JSON.stringify(allTests));
}

activeTestInfo.innerHTML=`Prueba activa: ${currentTest.name} - ${currentTest.distance}m`;
}

/* COMPETENCIA */
function startCompetition(){
lanes.innerHTML="";
results=[];
laneTimers={};

for(let i=1;i<=laneCount.value;i++){
laneTimers[i]={finished:false,time:0,athlete:null};

let options=athletes.map(a=>`<option value="${a.user}">${a.user}</option>`).join("");

lanes.innerHTML+=`
<div class="lane">
Carril ${i}
<select onchange="laneTimers[${i}].athlete=this.value">
<option value="">Asignar</option>${options}
</select>
<div class="timeDisplay" id="time${i}">0.000</div>
<button onclick="finishLane(${i})">TOCAR</button>
</div>`;
}
}

function startRace(){
startTime=Date.now();
interval=setInterval(()=>{
for(let i in laneTimers){
if(!laneTimers[i].finished){
let t=(Date.now()-startTime)/1000;
laneTimers[i].time=t;
document.getElementById("time"+i).innerText=t.toFixed(3);
}
}
},10);
}

function finishLane(i){
if(laneTimers[i].finished) return;
laneTimers[i].finished=true;

let athlete=laneTimers[i].athlete;
let time=laneTimers[i].time;

results.push({athlete,time});
currentTest.results.push({athlete,time});
localStorage.setItem("allTests",JSON.stringify(allTests));

renderRanking();
}

function renderRanking(){
ranking.innerHTML="";
results.sort((a,b)=>a.time-b.time);

results.forEach((r,i)=>{
ranking.innerHTML+=`${i+1}¬∞ ${r.athlete} - ${r.time.toFixed(3)}s<br>`;
});
}

function resetRace(){
clearInterval(interval);
results=[];
ranking.innerHTML="";
}

/* DESCARGA COMPLETA */
function downloadAll(){
let text="HISTORIAL GENERAL\n\n";

allTests.filter(t=>t.coach===currentUser)
.forEach(test=>{
text+="================================\n";
text+=`Prueba: ${test.name}\n`;
text+=`Distancia: ${test.distance}m\n`;
text+=`Fecha: ${test.date}\n\n`;

let athletesGrouped={};

test.results.forEach(r=>{
if(!athletesGrouped[r.athlete]) athletesGrouped[r.athlete]=[];
athletesGrouped[r.athlete].push(r.time);
});

for(let a in athletesGrouped){
let times=athletesGrouped[a];
let best=Math.min(...times);
let avg=times.reduce((x,y)=>x+y,0)/times.length;

text+=`${a}\n`;
text+=`Intentos: ${times.length}\n`;
text+=`Mejor tiempo: ${best.toFixed(3)}s\n`;
text+=`Promedio: ${avg.toFixed(3)}s\n\n`;
}
});

let blob=new Blob([text],{type:"text/plain"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="historial_completo.txt";
a.click();
}

</script>
</body>
</html>
