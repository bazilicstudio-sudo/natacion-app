<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèÜ Sistema Campeonato Oficial 2026</title>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:white}
.lane{background:#111827;padding:15px;margin:10px 0;border-radius:15px;text-align:center;}
.timeDisplay{font-size:24px;font-weight:bold;margin:10px 0;}
.hidden{display:none}
.medal{font-size:22px;}
.bigRanking{font-size:28px;}
</style>
</head>
<body>

<h2>üèÜ Sistema Campeonato Oficial 2026</h2>

<div class="card">
<input type="text" id="eventName" placeholder="Nombre del Evento">
<input type="number" id="laneCount" value="4" min="2" max="10">
<button class="btn-success" onclick="startCompetition()">Crear Carriles</button>
<button class="btn-success" onclick="startRaceNow()">üö¶ INICIAR AHORA</button>
<button class="btn-warning" onclick="pauseRace()">‚è∏ Pausar</button>
<button class="btn-success" onclick="resumeRace()">‚ñ∂ Reanudar</button>
<button class="btn-danger" onclick="resetRace()">üîÑ Reiniciar</button>
<button class="btn" onclick="toggleScreenMode()">üì∫ Modo Pantalla</button>
</div>

<div id="lanes"></div>

<div class="card">
<h3>Ranking</h3>
<div id="ranking"></div>
<button class="btn" onclick="downloadResults()">Descargar Resultados</button>
</div>

<div class="card">
<h3>Historial de Eventos</h3>
<div id="history"></div>
</div>

<script>

let laneTimers={};
let results=[];
let globalStartTime=0;
let globalInterval=null;
let raceStarted=false;
let paused=false;
let pausedTime=0;
let screenMode=false;

/* AUTOGUARDADO */
function saveState(){
localStorage.setItem("raceState",JSON.stringify({
laneTimers,results,globalStartTime,raceStarted
}));
}

function loadState(){
let state=JSON.parse(localStorage.getItem("raceState")||"null");
if(state){
laneTimers=state.laneTimers;
results=state.results;
globalStartTime=state.globalStartTime;
raceStarted=state.raceStarted;
renderRanking();
}
}

loadState();

/* COMPETENCIA */
function startCompetition(){
lanes.innerHTML="";
results=[];
laneTimers={};
clearInterval(globalInterval);
raceStarted=false;

for(let i=1;i<=laneCount.value;i++){
laneTimers[i]={finished:false,currentTime:0};

lanes.innerHTML+=`
<div class="lane">
<strong>Carril ${i}</strong>
<div class="timeDisplay" id="time${i}">0.000</div>
<button onclick="finishLane(${i})">TOCAR</button>
<button onclick="undoFinish(${i})">‚Ü© Reanudar</button>
</div>`;
}
saveState();
}

function startRaceNow(){
if(raceStarted)return;
raceStarted=true;
globalStartTime=Date.now();
globalInterval=setInterval(updateTimers,10);
}

function updateTimers(){
if(paused)return;
let now=Date.now();
for(let i in laneTimers){
if(!laneTimers[i].finished){
let elapsed=now-globalStartTime;
laneTimers[i].currentTime=elapsed;
document.getElementById("time"+i).innerText=(elapsed/1000).toFixed(3);
}
}
saveState();
}

function finishLane(i){
if(!raceStarted || laneTimers[i].finished)return;

laneTimers[i].finished=true;
let finalTime=laneTimers[i].currentTime/1000;

results.push({lane:i,time:finalTime});
results.sort((a,b)=>a.time-b.time);

updateRecords(i,finalTime);
renderRanking();
saveState();

if(results.length===Object.keys(laneTimers).length){
saveEvent();
}
}

function undoFinish(i){
laneTimers[i].finished=false;
results=results.filter(r=>r.lane!=i);
renderRanking();
saveState();
}

function renderRanking(){
ranking.innerHTML="";
results.forEach((r,index)=>{
let medal="";
if(index==0)medal="ü•á";
if(index==1)medal="ü•à";
if(index==2)medal="ü•â";

ranking.innerHTML+=`
<div class="${screenMode?'bigRanking':''}">
<span class="medal">${medal}</span>
${index+1}¬∞ Carril ${r.lane}
| ${r.time.toFixed(3)}s
</div>`;
});
}

/* RECORD PERSONAL */
function updateRecords(lane,time){
let records=JSON.parse(localStorage.getItem("records")||"{}");
if(!records[lane] || time<records[lane]){
records[lane]=time;
}
localStorage.setItem("records",JSON.stringify(records));
}

/* HISTORIAL */
function saveEvent(){
let history=JSON.parse(localStorage.getItem("history")||"[]");
history.push({
event:eventName.value||"Evento sin nombre",
date:new Date().toLocaleString(),
results
});
localStorage.setItem("history",JSON.stringify(history));
loadHistory();
}

function loadHistory(){
let history=JSON.parse(localStorage.getItem("history")||"[]");
historyDiv="";
history.forEach(e=>{
historyDiv+=`<div>
<strong>${e.event}</strong><br>
${e.date}<br>
Resultados: ${e.results.length}
</div><hr>`;
});
document.getElementById("history").innerHTML=historyDiv;
}

loadHistory();

/* PANTALLA */
function toggleScreenMode(){
screenMode=!screenMode;
document.querySelectorAll(".card").forEach(c=>{
if(screenMode)c.style.display="none";
else c.style.display="block";
});
ranking.parentElement.style.display="block";
}

/* CONTROL */
function pauseRace(){paused=true;}
function resumeRace(){paused=false;}
function resetRace(){
clearInterval(globalInterval);
raceStarted=false;
results=[];
renderRanking();
}

/* DESCARGA */
function downloadResults(){
let text="RESULTADOS\n\n";
results.forEach(r=>{
text+=`Carril ${r.lane} - ${r.time}s\n`;
});
let blob=new Blob([text],{type:"text/plain"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="resultados.txt";
a.click();
}

</script>
</body>
</html>
