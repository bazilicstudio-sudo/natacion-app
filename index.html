<script>

function safeParse(key){
try{return JSON.parse(localStorage.getItem(key))||[];}
catch{return [];}
}

let coaches=safeParse("coaches");
let athletes=safeParse("athletes");
let allTests=safeParse("allTests");
let currentTest=null;

if(!coaches.find(c=>c.user==="admin")){
coaches.push({user:"admin",pass:"1234"});
localStorage.setItem("coaches",JSON.stringify(coaches));
}

/* =========================
   LOGIN Y USUARIOS
========================= */

function restoreAccess(){
localStorage.removeItem("coaches");
coaches=[{user:"admin",pass:"1234"}];
localStorage.setItem("coaches",JSON.stringify(coaches));
alert("Usuario: admin\nClave: 1234");
location.reload();
}

function login(){
let coach=coaches.find(c=>c.user===loginUser.value && c.pass===loginPass.value);
if(!coach){alert("Incorrecto");return;}
loginCard.classList.add("hidden");
app.classList.remove("hidden");
renderAll();
}

function logout(){location.reload();}

function createCoach(){
if(!newCoachUser.value||!newCoachPass.value)return;
if(coaches.find(c=>c.user===newCoachUser.value)){alert("Ya existe");return;}
coaches.push({user:newCoachUser.value,pass:newCoachPass.value});
localStorage.setItem("coaches",JSON.stringify(coaches));
renderCoaches();
}

function deleteCoach(user){
if(user==="admin"){alert("No puedes eliminar admin");return;}
coaches=coaches.filter(c=>c.user!==user);
localStorage.setItem("coaches",JSON.stringify(coaches));
renderCoaches();
}

/* =========================
   ATLETAS
========================= */

function createAthlete(){
if(!newAthleteUser.value||!newAthletePass.value)return;
athletes.push({
user:newAthleteUser.value,
pass:newAthletePass.value,
age:newAthleteAge.value||"",
sex:newAthleteSex.value||""
});
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

function editAthlete(index){
let a=athletes[index];
let newUser=prompt("Editar nombre:",a.user);
if(!newUser)return;
let newPass=prompt("Editar contraseÃ±a:",a.pass);
if(!newPass)return;
let newAge=prompt("Editar edad:",a.age);
let newSex=prompt("Editar sexo (Masculino/Femenino):",a.sex);

athletes[index]={user:newUser,pass:newPass,age:newAge||"",sex:newSex||""};
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

function deleteAthlete(user){
athletes=athletes.filter(a=>a.user!==user);
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

/* =========================
   PRUEBAS
========================= */

function activateTest(){
if(!testName.value||!testDistance.value||!testDate.value)return;

currentTest={
name:testName.value,
distance:testDistance.value,
date:testDate.value,
results:[]
};

allTests.push(currentTest);
localStorage.setItem("allTests",JSON.stringify(allTests));
activeTestInfo.innerHTML=`Activa: ${currentTest.name} - ${currentTest.distance}m - ${currentTest.date}`;
renderTests();
}

function addManualTime(){
if(!currentTest)return alert("Activa prueba");
let athlete=manualAthlete.value;
let time=parseFloat(manualTime.value)||0;

currentTest.results.push({
athlete,
tiempoCronometro:0,
tiempoManual:time
});

localStorage.setItem("allTests",JSON.stringify(allTests));
alert("Tiempo manual guardado");
}

/* =========================
   CRONOMETRO PROFESIONAL
========================= */

let results=[];
let laneTimers={};
let globalInterval=null;
let raceStarted=false;
let paused=false;
let startTime=0;
let elapsed=0;

function startCompetition(){
lanes.innerHTML="";
results=[];
laneTimers={};
clearInterval(globalInterval);
raceStarted=false;
paused=false;
elapsed=0;

for(let i=1;i<=laneCount.value;i++){
laneTimers[i]={finished:false,currentTime:0,athlete:null};
let options=athletes.map(a=>`<option value="${a.user}">${a.user}</option>`).join("");
lanes.innerHTML+=`
<div class="lane">
Carril ${i}
<select onchange="laneTimers[${i}].athlete=this.value">
<option value="">Asignar</option>${options}
</select>
<div class="timeDisplay" id="time${i}">0.000</div>
<button onclick="finishLane(${i})">TOCAR</button>
</div>`;
}
}

function startRaceNow(){
if(raceStarted)return;
raceStarted=true;
paused=false;
startTime=Date.now();
globalInterval=setInterval(updateTimers,10);
}

function updateTimers(){
if(!raceStarted)return;

let currentElapsed = paused
? elapsed
: elapsed + (Date.now() - startTime);

for(let i in laneTimers){
if(!laneTimers[i].finished){
laneTimers[i].currentTime=currentElapsed;
document.getElementById("time"+i).innerText=(currentElapsed/1000).toFixed(3);
}
}
}

function pauseRace(){
if(!raceStarted || paused)return;
paused=true;
elapsed += Date.now() - startTime;
}

function resumeRace(){
if(!paused)return;
paused=false;
startTime=Date.now();
}

/* ðŸ”¥ REINICIAR SIN BORRAR DATOS */
function resetRace(){
clearInterval(globalInterval);
raceStarted=false;
paused=false;
elapsed=0;

for(let i in laneTimers){
laneTimers[i].finished=false;
laneTimers[i].currentTime=0;
document.getElementById("time"+i).innerText="0.000";
}

results=[];
ranking.innerHTML="";
}

/* =========================
   FINALIZAR CARRIL
========================= */

function finishLane(i){
if(!raceStarted||laneTimers[i].finished)return;

laneTimers[i].finished=true;
let finalTime=laneTimers[i].currentTime/1000;
let athleteName=laneTimers[i].athlete||"Sin atleta";

results.push({lane:i,name:athleteName,time:finalTime});

if(currentTest){
currentTest.results.push({
athlete:athleteName,
tiempoCronometro:finalTime,
tiempoManual:0
});
localStorage.setItem("allTests",JSON.stringify(allTests));
}

renderRanking();
}

function renderRanking(){
ranking.innerHTML="";
results.sort((a,b)=>a.time-b.time);
results.forEach((r,i)=>{
ranking.innerHTML+=`${i+1}Â° ${r.name} - ${r.time.toFixed(3)}s<br>`;
});
}

/* =========================
   DESCARGA PROFESIONAL
========================= */

function downloadResults(){

let text="HISTORIAL COMPLETO PROFESIONAL\n\n";

allTests.forEach(t=>{

text+="=================================================\n";
text+=`PRUEBA: ${t.name}\nDistancia: ${t.distance}m\nFecha: ${t.date}\n\n`;

let agrupado={};

t.results.forEach(r=>{
if(!agrupado[r.athlete]) agrupado[r.athlete]=[];
let tiempo=r.tiempoCronometro||r.tiempoManual||0;
agrupado[r.athlete].push(tiempo);
});

for(let atleta in agrupado){

let atletaInfo=athletes.find(a=>a.user===atleta)||{};
let tiempos=agrupado[atleta];

let promedio=tiempos.reduce((a,b)=>a+b,0)/tiempos.length;
let mejor=Math.min(...tiempos);
let peor=Math.max(...tiempos);

text+=`Atleta: ${atleta}\n`;
text+=`Edad: ${atletaInfo.age||"-"} | Sexo: ${atletaInfo.sex||"-"}\n`;
text+=`Intentos: ${tiempos.length}\n`;
text+=`Tiempos: ${tiempos.map(t=>t.toFixed(3)).join(" - ")}\n`;
text+=`Mejor: ${mejor.toFixed(3)}s | Peor: ${peor.toFixed(3)}s\n`;
text+=`Promedio: ${promedio.toFixed(3)}s\n`;
text+="-----------------------------------------------\n";

}

text+="\n";
});

let blob=new Blob([text],{type:"text/plain"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="historial_profesional.txt";
a.click();
}

/* =========================
   RENDERS
========================= */

function renderCoaches(){
coachList.innerHTML="";
coaches.forEach(c=>{
coachList.innerHTML+=`${c.user}
<button class="small-btn btn-danger" onclick="deleteCoach('${c.user}')">Eliminar</button><br>`;
});
}

function renderAthletes(){
athleteList.innerHTML="";
manualAthlete.innerHTML="";
athletes.forEach((a,index)=>{
athleteList.innerHTML+=`${a.user} | Edad: ${a.age||"-"} | Sexo: ${a.sex||"-"}
<button class="small-btn btn-warning" onclick="editAthlete(${index})">Editar</button>
<button class="small-btn btn-danger" onclick="deleteAthlete('${a.user}')">Eliminar</button><br>`;
manualAthlete.innerHTML+=`<option value="${a.user}">${a.user}</option>`;
});
}

function renderTests(){
testList.innerHTML="";
allTests.forEach((t,i)=>{
testList.innerHTML+=`${t.name} - ${t.distance}m - ${t.date}
<button class="small-btn btn-danger" onclick="deleteTest(${i})">Eliminar</button><br>`;
});
}

function deleteTest(index){
allTests.splice(index,1);
localStorage.setItem("allTests",JSON.stringify(allTests));
renderTests();
}

function renderAll(){
renderCoaches();
renderAthletes();
renderTests();
}

</script>
