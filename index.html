<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>游끩 Sistema Competencia Elite</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:15px}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none}
button{padding:8px 12px;margin:4px;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
.btn{background:#2563eb;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-success{background:#16a34a;color:white}
.hidden{display:none}
.lane{
background:#111827;
padding:10px;
margin:8px 0;
border-radius:10px;
display:flex;
justify-content:space-between;
align-items:center;
transition:0.3s;
}
.lane.running{
box-shadow:0 0 15px #22c55e;
animation:pulse 1s infinite;
}
.lane.finished{background:#1e293b;}
@keyframes pulse{
0%{opacity:1}
50%{opacity:0.6}
100%{opacity:1}
}
</style>
</head>
<body>

<h2>游끩 Sistema Competencia Elite</h2>

<!-- SETUP ADMIN -->
<div id="setupCard" class="card hidden">
<h3>Crear Administrador</h3>
<input type="text" id="adminUser" placeholder="Usuario Admin">
<input type="password" id="adminPass" placeholder="Contrase침a">
<button class="btn-success" onclick="createAdmin()">Crear Cuenta</button>
</div>

<!-- LOGIN -->
<div id="loginCard" class="card hidden">
<h3>Login</h3>
<input type="text" id="loginUser" placeholder="Usuario">
<input type="password" id="loginPass" placeholder="Contrase침a">
<button class="btn" onclick="login()">Ingresar</button>
</div>

<div id="app" class="hidden">

<div class="card">
<button class="btn-danger" onclick="logout()">Cerrar Sesi칩n</button>
</div>

<div id="adminNav" class="card hidden">
<button class="btn" onclick="showSection('competition')">Competencia</button>
<button class="btn" onclick="showSection('training')">Entrenamiento</button>
<button class="btn" onclick="showSection('admin')">Administraci칩n</button>
</div>

<!-- COMPETENCIA -->
<div id="competitionSection" class="hidden">

<div class="card">
<h3>Evento</h3>
<input type="text" id="eventName" placeholder="Nombre del evento">
<input type="number" id="laneCount" min="2" max="10" value="8">
<button class="btn-success" onclick="startCompetition()">Iniciar Competencia</button>
</div>

<div class="card">
<h3>Carriles</h3>
<div id="lanes"></div>
</div>

<div class="card">
<h3>Ranking</h3>
<div id="ranking"></div>
</div>

<div class="card">
<h3>Historial Competencias</h3>
<div id="history"></div>
</div>

</div>

<!-- ENTRENAMIENTO -->
<div id="trainingSection" class="hidden">

<div class="card">
<h3>Registrar Tiempo</h3>
<select id="trainingAthlete"></select>
<input type="number" id="trainingTime" placeholder="Tiempo en milisegundos">
<button class="btn" onclick="saveTraining()">Guardar</button>
<button class="btn-success" onclick="exportExcel()">Exportar Excel</button>
<button class="btn-success" onclick="exportFullPDF()">Exportar PDF Academia</button>
</div>

<div class="card">
<h3>Historial Entrenamiento</h3>
<div id="trainingHistory"></div>
</div>

<div class="card">
<h3>Progreso por Atleta</h3>
<select id="chartAthlete"></select>
<canvas id="progressChart"></canvas>
<button class="btn-success" onclick="exportAthletePDF()">Exportar PDF Individual</button>
</div>

</div>

<!-- ADMIN -->
<div id="adminSection" class="hidden">

<div class="card">
<h3>Crear Atleta</h3>
<input type="text" id="newAthlete">
<input type="password" id="newPass" placeholder="Contrase침a">
<button class="btn" onclick="createAthlete()">Crear</button>
</div>

<div class="card">
<h3>Lista Atletas</h3>
<div id="athleteList"></div>
</div>

</div>

<!-- PANEL ATLETA -->
<div id="athletePanel" class="hidden">
<div class="card">
<h3>Mis Resultados</h3>
<div id="myResults"></div>
</div>
</div>

</div>

<script>
// ===============================
// VARIABLES GLOBALES
// ===============================

let currentUser = null;
let timerInterval = null;
let startTime = null;
let results = [];
let progressChart = null;

// ===============================
// INICIO
// ===============================

window.onload = () => {
    if(!localStorage.getItem("admin")){
        document.getElementById("setupCard").classList.remove("hidden");
    }else{
        document.getElementById("loginCard").classList.remove("hidden");
    }
};

// ===============================
// ADMIN
// ===============================

function createAdmin(){
    const user = adminUser.value;
    const pass = adminPass.value;
    localStorage.setItem("admin", JSON.stringify({user, pass}));
    alert("Admin creado");
    location.reload();
}

function login(){
    const admin = JSON.parse(localStorage.getItem("admin"));
    const athletes = JSON.parse(localStorage.getItem("athletes") || "[]");

    if(loginUser.value === admin.user && loginPass.value === admin.pass){
        currentUser = "admin";
        loginCard.classList.add("hidden");
        app.classList.remove("hidden");
        adminNav.classList.remove("hidden");
        showSection("competition");
        loadAthletes();
    }else{
        const athlete = athletes.find(a=>a.user===loginUser.value && a.pass===loginPass.value);
        if(athlete){
            currentUser = athlete.user;
            loginCard.classList.add("hidden");
            app.classList.remove("hidden");
            athletePanel.classList.remove("hidden");
            loadMyResults();
        }else{
            alert("Credenciales incorrectas");
        }
    }
}

function logout(){
    location.reload();
}

// ===============================
// SECCIONES
// ===============================

function showSection(sec){
    competitionSection.classList.add("hidden");
    trainingSection.classList.add("hidden");
    adminSection.classList.add("hidden");

    if(sec==="competition") competitionSection.classList.remove("hidden");
    if(sec==="training") trainingSection.classList.remove("hidden");
    if(sec==="admin") adminSection.classList.remove("hidden");
}

// ===============================
// ATLETAS
// ===============================

function createAthlete(){
    let athletes = JSON.parse(localStorage.getItem("athletes")||"[]");
    athletes.push({user:newAthlete.value, pass:newPass.value});
    localStorage.setItem("athletes", JSON.stringify(athletes));
    newAthlete.value="";
    newPass.value="";
    loadAthletes();
}

function loadAthletes(){
    let athletes = JSON.parse(localStorage.getItem("athletes")||"[]");
    athleteList.innerHTML="";
    trainingAthlete.innerHTML="";
    chartAthlete.innerHTML="";
    athletes.forEach(a=>{
        athleteList.innerHTML+=`<div>${a.user}</div>`;
        trainingAthlete.innerHTML+=`<option>${a.user}</option>`;
        chartAthlete.innerHTML+=`<option>${a.user}</option>`;
    });
}

// ===============================
// COMPETENCIA
// ===============================

function startCompetition(){
    lanes.innerHTML="";
    results=[];
    const count = parseInt(laneCount.value);

    for(let i=1;i<=count;i++){
        lanes.innerHTML+=`
        <div class="lane" id="lane${i}">
            <span>Carril ${i}</span>
            <div>
                <button class="btn" onclick="startRace(${i})">Start</button>
                <button class="btn-success" onclick="finishRace(${i})">Finish</button>
                <span id="time${i}">0.000</span>
            </div>
        </div>`;
    }
}

function startRace(i){
    startTime = Date.now();
    document.getElementById("lane"+i).classList.add("running");
    timerInterval = setInterval(()=>{
        let t = Date.now()-startTime;
        document.getElementById("time"+i).innerText=(t/1000).toFixed(3);
    },10);
}

function finishRace(i){
    clearInterval(timerInterval);
    let finalTime = parseFloat(document.getElementById("time"+i).innerText);
    document.getElementById("lane"+i).classList.remove("running");
    document.getElementById("lane"+i).classList.add("finished");

    results.push({lane:i,time:finalTime});
    results.sort((a,b)=>a.time-b.time);

    ranking.innerHTML="";
    results.forEach((r,index)=>{
        ranking.innerHTML+=`<div>游볞 ${index+1}춿 - Carril ${r.lane} - ${r.time}s</div>`;
    });

    saveCompetition();
}

function saveCompetition(){
    let historyData = JSON.parse(localStorage.getItem("competitionHistory")||"[]");
    historyData.push({
        event:eventName.value,
        date:new Date().toLocaleString(),
        results:results
    });
    localStorage.setItem("competitionHistory", JSON.stringify(historyData));
    loadHistory();
}

function loadHistory(){
    let historyData = JSON.parse(localStorage.getItem("competitionHistory")||"[]");
    history.innerHTML="";
    historyData.forEach(h=>{
        history.innerHTML+=`<div>${h.date} - ${h.event}</div>`;
    });
}

// ===============================
// ENTRENAMIENTO
// ===============================

function saveTraining(){
    let data = JSON.parse(localStorage.getItem("trainingData")||"[]");
    data.push({
        athlete:trainingAthlete.value,
        time:parseFloat(trainingTime.value),
        date:new Date().toLocaleDateString()
    });
    localStorage.setItem("trainingData", JSON.stringify(data));
    trainingTime.value="";
    loadTraining();
}

function loadTraining(){
    let data = JSON.parse(localStorage.getItem("trainingData")||"[]");
    trainingHistory.innerHTML="";
    data.forEach(d=>{
        trainingHistory.innerHTML+=`<div>${d.date} - ${d.athlete} - ${d.time} ms</div>`;
    });
}

function loadMyResults(){
    let data = JSON.parse(localStorage.getItem("trainingData")||"[]");
    myResults.innerHTML="";
    data.filter(d=>d.athlete===currentUser)
    .forEach(d=>{
        myResults.innerHTML+=`<div>${d.date} - ${d.time} ms</div>`;
    });
}
// ===============================
// GR츼FICO
// ===============================

chartAthlete.addEventListener("change", updateChart);

function updateChart(){
    let athlete = chartAthlete.value;
    let data = JSON.parse(localStorage.getItem("trainingData")||"[]")
        .filter(d=>d.athlete===athlete);

    let labels = data.map(d=>d.date);
    let times = data.map(d=>d.time);

    if(progressChart) progressChart.destroy();

    progressChart = new Chart(progressChart=document.getElementById("progressChart"),{
        type:"line",
        data:{
            labels:labels,
            datasets:[{
                label:"Tiempo (ms)",
                data:times
            }]
        }
    });
}

// ===============================
// EXPORTACIONES
// ===============================

function exportExcel(){
    let data = JSON.parse(localStorage.getItem("trainingData")||"[]");
    let ws = XLSX.utils.json_to_sheet(data);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Entrenamiento");
    XLSX.writeFile(wb, "Entrenamiento.xlsx");
}

async function exportFullPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let data = JSON.parse(localStorage.getItem("trainingData")||"[]");

    doc.text("Reporte Academia",20,20);
    let y=30;
    data.forEach(d=>{
        doc.text(`${d.date} - ${d.athlete} - ${d.time} ms`,20,y);
        y+=8;
    });

    doc.save("Reporte_Academia.pdf");
}

async function exportAthletePDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let athlete = chartAthlete.value;
    let data = JSON.parse(localStorage.getItem("trainingData")||"[]")
        .filter(d=>d.athlete===athlete);

    doc.text("Reporte Individual",20,20);
    let y=30;
    data.forEach(d=>{
        doc.text(`${d.date} - ${d.time} ms`,20,y);
        y+=8;
    });

    doc.save(`Reporte_${athlete}.pdf`);
}

// ===============================
loadTraining();
loadHistory();
</script>
</body>
</html>
