<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèä Control Nataci√≥n PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: #eef2f7;
}

h1 {
    text-align: center;
}

button {
    padding: 10px 15px;
    margin: 5px 0;
    border: none;
    border-radius: 6px;
    background: #0d6efd;
    color: white;
    cursor: pointer;
}

button.danger {
    background: red;
}

input, select {
    padding: 8px;
    margin: 5px 0;
    width: 100%;
}

.card {
    background: white;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

#timer {
    font-size: 2.5rem;
    text-align: center;
    margin: 20px 0;
    font-weight: bold;
}

canvas {
    background: white;
    border-radius: 10px;
}
</style>
</head>
<body>

<h1>üèä Control de Atletas</h1>

<div class="card">
    <h3>Agregar Atleta</h3>
    <input type="text" id="athleteName" placeholder="Nombre del atleta">
    <button onclick="addAthlete()">Agregar</button>
</div>

<div class="card">
    <h3>Cron√≥metro Profesional</h3>
    <div id="timer">00:00.000</div>
    <button onclick="startTimer()">Iniciar</button>
    <button onclick="stopTimer()">Detener</button>
    <button onclick="resetTimer()">Reiniciar</button>
    <button onclick="saveTime()">Guardar Tiempo</button>
</div>

<div class="card">
    <h3>Seleccionar Atleta</h3>
    <select id="athleteSelect"></select>
    <input type="text" id="observation" placeholder="Observaci√≥n (opcional)">
</div>

<div class="card">
    <h3>Progreso por Atleta</h3>
    <canvas id="progressChart"></canvas>
</div>

<script>
let athletes = JSON.parse(localStorage.getItem("athletes")) || [];
let chart;

let startTime = 0;
let elapsedTime = 0;
let timerInterval = null;
let running = false;

function formatTime(ms) {
    let minutes = Math.floor(ms / 60000);
    let seconds = Math.floor((ms % 60000) / 1000);
    let mil = Math.floor(ms % 1000);

    return (
        String(minutes).padStart(2,'0') + ":" +
        String(seconds).padStart(2,'0') + "." +
        String(mil).padStart(3,'0')
    );
}

function startTimer() {
    if (running) return;

    running = true;
    startTime = performance.now() - elapsedTime;

    timerInterval = setInterval(() => {
        elapsedTime = performance.now() - startTime;
        document.getElementById("timer").innerText = formatTime(elapsedTime);
    }, 10);
}

function stopTimer() {
    running = false;
    clearInterval(timerInterval);
}

function resetTimer() {
    running = false;
    clearInterval(timerInterval);
    elapsedTime = 0;
    document.getElementById("timer").innerText = "00:00.000";
}

function saveTime() {
    let select = document.getElementById("athleteSelect");
    let name = select.value;

    if (!name) return alert("Selecciona un atleta");

    let athlete = athletes.find(a => a.name === name);

    athlete.times.push({
        time: Math.floor(elapsedTime),
        obs: document.getElementById("observation").value
    });

    saveData();
    updateChart();
    resetTimer();
    document.getElementById("observation").value = "";
}

function addAthlete() {
    let name = document.getElementById("athleteName").value;
    if (!name) return;

    let colors = ["red","blue","green","orange","purple","brown","black"];
    let color = colors[athletes.length % colors.length];

    athletes.push({ name, times: [], color });

    document.getElementById("athleteName").value = "";
    saveData();
    updateSelect();
    updateChart();
}

function updateSelect() {
    let select = document.getElementById("athleteSelect");
    select.innerHTML = "";
    athletes.forEach(a => {
        let option = document.createElement("option");
        option.value = a.name;
        option.textContent = a.name;
        select.appendChild(option);
    });
}

function saveData() {
    localStorage.setItem("athletes", JSON.stringify(athletes));
}

function updateChart() {
    let ctx = document.getElementById("progressChart").getContext("2d");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: Array.from({length: 20}, (_, i) => "Intento " + (i+1)),
            datasets: athletes.map(a => ({
                label: a.name,
                data: a.times.map(t => t.time / 1000),
                borderColor: a.color,
                tension: 0,
                fill: false
            }))
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            }
        }
    });
}

updateSelect();
updateChart();

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>
