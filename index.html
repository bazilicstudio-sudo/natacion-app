<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO MAX</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
.hidden{display:none}
</style>
</head>
<body>

<h2>游끩 Sistema Competencia Elite PRO MAX</h2>

<div id="loginCard" class="card">
<h3>Crear / Ingresar Entrenador</h3>
<input type="text" id="coachUser" placeholder="Usuario entrenador">
<input type="password" id="coachPass" placeholder="Contrase침a">

<label>Logo (Marca de agua PNG)</label>
<input type="file" id="coachLogoFile" accept="image/*">

<label>Firma PNG</label>
<input type="file" id="coachSignatureFile" accept="image/*">

<button class="btn-success" onclick="registerCoach()">Crear Entrenador</button>
<button class="btn" onclick="login()">Ingresar</button>
</div>

<div id="app" class="hidden">

<button class="btn-danger" onclick="logout()">Cerrar Sesi칩n</button>

<div class="card">
<h3>游늶 Datos de la Prueba</h3>
<input type="text" id="testName" placeholder="Nombre prueba">
<input type="number" id="testDistance" placeholder="Metros">
<input type="date" id="testDate">
<button class="btn-success" onclick="activateTest()">Activar Prueba</button>
</div>

<div class="card">
<h3>游닌 Descargar PDF</h3>
<button class="btn" onclick="downloadFull()">Descargar Historial Completo</button>
</div>

</div>

<script>
const { jsPDF } = window.jspdf;

let coaches = JSON.parse(localStorage.getItem("coaches")) || [];
let allTests = JSON.parse(localStorage.getItem("allTests")) || [];
let currentCoach = null;

/* ================= CONVERTIR IMAGEN A BASE64 ================= */

function fileToBase64(file){
return new Promise((resolve,reject)=>{
const reader=new FileReader();
reader.onload=()=>resolve(reader.result);
reader.onerror=error=>reject(error);
reader.readAsDataURL(file);
});
}

/* ================= ENTRENADOR ================= */

async function registerCoach(){

if(!coachUser.value || !coachPass.value) return alert("Complete datos");

if(coaches.some(c=>c.user===coachUser.value)){
alert("Ya existe ese entrenador");
return;
}

let logoBase64="";
let signatureBase64="";

if(coachLogoFile.files[0]){
logoBase64 = await fileToBase64(coachLogoFile.files[0]);
}

if(coachSignatureFile.files[0]){
signatureBase64 = await fileToBase64(coachSignatureFile.files[0]);
}

coaches.push({
user:coachUser.value,
pass:coachPass.value,
logo:logoBase64,
signature:signatureBase64
});

localStorage.setItem("coaches",JSON.stringify(coaches));
alert("Entrenador creado correctamente");
}

function login(){
let coach = coaches.find(c=>c.user===coachUser.value && c.pass===coachPass.value);
if(!coach) return alert("Datos incorrectos");

currentCoach = coach;
loginCard.classList.add("hidden");
app.classList.remove("hidden");
}

function logout(){
location.reload();
}

/* ================= PRUEBAS ================= */

function activateTest(){
if(!testName.value || !testDate.value){
alert("Complete nombre y fecha");
return;
}

allTests.push({
name:testName.value,
distance:testDistance.value,
date:testDate.value,
coach:currentCoach.user
});

localStorage.setItem("allTests",JSON.stringify(allTests));
alert("Prueba activada");
}

/* ================= PDF ================= */

async function downloadFull(){
let myTests = allTests.filter(t=>t.coach===currentCoach.user);
await generarPDF(myTests,"Historial_Completo");
}

async function generarPDF(tests,nombre){

const doc=new jsPDF("p","mm","letter");
const pageWidth = doc.internal.pageSize.getWidth();
const pageHeight = doc.internal.pageSize.getHeight();

let y=35;

const now = new Date();
const fechaHora = now.toLocaleString();

/* ENCABEZADO */
function drawHeader(){
doc.setFontSize(16);
doc.text("Sistema Competencia Elite PRO MAX",pageWidth/2,15,null,null,"center");

doc.setFontSize(11);
doc.text("Entrenador: "+currentCoach.user,20,22);

doc.setFontSize(9);
doc.text("Generado: "+fechaHora,pageWidth-20,22,null,null,"right");
}

/* MARCA DE AGUA */
async function addWatermark(){
if(!currentCoach.logo) return;

const img = new Image();
img.src=currentCoach.logo;

await new Promise(resolve=>{
img.onload=function(){

const imgWidth = pageWidth*0.6;
const imgHeight = imgWidth*(img.height/img.width);
const x=(pageWidth-imgWidth)/2;
const y=(pageHeight-imgHeight)/2;

doc.setGState(new doc.GState({opacity:0.08}));
doc.addImage(img,"PNG",x,y,imgWidth,imgHeight);
doc.setGState(new doc.GState({opacity:1}));

resolve();
};
});
}

/* FIRMA */
async function addSignature(){
if(!currentCoach.signature) return;

const img = new Image();
img.src=currentCoach.signature;

await new Promise(resolve=>{
img.onload=function(){

const imgWidth=50;
const imgHeight=imgWidth*(img.height/img.width);
const x=pageWidth-imgWidth-20;
const y=pageHeight-imgHeight-20;

doc.addImage(img,"PNG",x,y,imgWidth,imgHeight);

resolve();
};
});
}

/* GENERAR CONTENIDO */

drawHeader();
await addWatermark();

for(let test of tests){

if(y>230){
doc.addPage();
y=35;
drawHeader();
await addWatermark();
}

doc.setFontSize(12);
doc.text(`Prueba: ${test.name}`,20,y); y+=6;
doc.text(`Distancia: ${test.distance||"-"}m`,20,y); y+=6;
doc.text(`Fecha: ${test.date}`,20,y); y+=12;
}

/* FIRMA SOLO ULTIMA PAGINA */
doc.setPage(doc.getNumberOfPages());
await addSignature();

/* NUMERACION */
const totalPages=doc.getNumberOfPages();

for(let i=1;i<=totalPages;i++){
doc.setPage(i);
doc.setFontSize(9);
doc.text(`P치gina ${i} de ${totalPages}`,pageWidth/2,pageHeight-10,null,null,"center");
}

doc.save(nombre+".pdf");
}
</script>

</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO MAX</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
.hidden{display:none}
</style>
</head>
<body>

<h2>游끩 Sistema Competencia Elite PRO MAX</h2>

<div id="loginCard" class="card">
<h3>Crear / Ingresar Entrenador</h3>
<input type="text" id="coachUser" placeholder="Usuario entrenador">
<input type="password" id="coachPass" placeholder="Contrase침a">

<label>Logo (Marca de agua PNG)</label>
<input type="file" id="coachLogoFile" accept="image/*">

<label>Firma PNG</label>
<input type="file" id="coachSignatureFile" accept="image/*">

<button class="btn-success" onclick="registerCoach()">Crear Entrenador</button>
<button class="btn" onclick="login()">Ingresar</button>
</div>

<div id="app" class="hidden">

<button class="btn-danger" onclick="logout()">Cerrar Sesi칩n</button>

<div class="card">
<h3>游늶 Datos de la Prueba</h3>
<input type="text" id="testName" placeholder="Nombre prueba">
<input type="number" id="testDistance" placeholder="Metros">
<input type="date" id="testDate">
<button class="btn-success" onclick="activateTest()">Activar Prueba</button>
</div>

<div class="card">
<h3>游닌 Descargar PDF</h3>
<button class="btn" onclick="downloadFull()">Descargar Historial Completo</button>
</div>

</div>

<script>
const { jsPDF } = window.jspdf;

let coaches = JSON.parse(localStorage.getItem("coaches")) || [];
let allTests = JSON.parse(localStorage.getItem("allTests")) || [];
let currentCoach = null;

/* ================= CONVERTIR IMAGEN A BASE64 ================= */

function fileToBase64(file){
return new Promise((resolve,reject)=>{
const reader=new FileReader();
reader.onload=()=>resolve(reader.result);
reader.onerror=error=>reject(error);
reader.readAsDataURL(file);
});
}

/* ================= ENTRENADOR ================= */

async function registerCoach(){

if(!coachUser.value || !coachPass.value) return alert("Complete datos");

if(coaches.some(c=>c.user===coachUser.value)){
alert("Ya existe ese entrenador");
return;
}

let logoBase64="";
let signatureBase64="";

if(coachLogoFile.files[0]){
logoBase64 = await fileToBase64(coachLogoFile.files[0]);
}

if(coachSignatureFile.files[0]){
signatureBase64 = await fileToBase64(coachSignatureFile.files[0]);
}

coaches.push({
user:coachUser.value,
pass:coachPass.value,
logo:logoBase64,
signature:signatureBase64
});

localStorage.setItem("coaches",JSON.stringify(coaches));
alert("Entrenador creado correctamente");
}

function login(){
let coach = coaches.find(c=>c.user===coachUser.value && c.pass===coachPass.value);
if(!coach) return alert("Datos incorrectos");

currentCoach = coach;
loginCard.classList.add("hidden");
app.classList.remove("hidden");
}

function logout(){
location.reload();
}

/* ================= PRUEBAS ================= */

function activateTest(){
if(!testName.value || !testDate.value){
alert("Complete nombre y fecha");
return;
}

allTests.push({
name:testName.value,
distance:testDistance.value,
date:testDate.value,
coach:currentCoach.user
});

localStorage.setItem("allTests",JSON.stringify(allTests));
alert("Prueba activada");
}

/* ================= PDF ================= */

async function downloadFull(){
let myTests = allTests.filter(t=>t.coach===currentCoach.user);
await generarPDF(myTests,"Historial_Completo");
}

async function generarPDF(tests,nombre){

const doc=new jsPDF("p","mm","letter");
const pageWidth = doc.internal.pageSize.getWidth();
const pageHeight = doc.internal.pageSize.getHeight();

let y=35;

const now = new Date();
const fechaHora = now.toLocaleString();

/* ENCABEZADO */
function drawHeader(){
doc.setFontSize(16);
doc.text("Sistema Competencia Elite PRO MAX",pageWidth/2,15,null,null,"center");

doc.setFontSize(11);
doc.text("Entrenador: "+currentCoach.user,20,22);

doc.setFontSize(9);
doc.text("Generado: "+fechaHora,pageWidth-20,22,null,null,"right");
}

/* MARCA DE AGUA */
async function addWatermark(){
if(!currentCoach.logo) return;

const img = new Image();
img.src=currentCoach.logo;

await new Promise(resolve=>{
img.onload=function(){

const imgWidth = pageWidth*0.6;
const imgHeight = imgWidth*(img.height/img.width);
const x=(pageWidth-imgWidth)/2;
const y=(pageHeight-imgHeight)/2;

doc.setGState(new doc.GState({opacity:0.08}));
doc.addImage(img,"PNG",x,y,imgWidth,imgHeight);
doc.setGState(new doc.GState({opacity:1}));

resolve();
};
});
}

/* FIRMA */
async function addSignature(){
if(!currentCoach.signature) return;

const img = new Image();
img.src=currentCoach.signature;

await new Promise(resolve=>{
img.onload=function(){

const imgWidth=50;
const imgHeight=imgWidth*(img.height/img.width);
const x=pageWidth-imgWidth-20;
const y=pageHeight-imgHeight-20;

doc.addImage(img,"PNG",x,y,imgWidth,imgHeight);

resolve();
};
});
}

/* GENERAR CONTENIDO */

drawHeader();
await addWatermark();

for(let test of tests){

if(y>230){
doc.addPage();
y=35;
drawHeader();
await addWatermark();
}

doc.setFontSize(12);
doc.text(`Prueba: ${test.name}`,20,y); y+=6;
doc.text(`Distancia: ${test.distance||"-"}m`,20,y); y+=6;
doc.text(`Fecha: ${test.date}`,20,y); y+=12;
}

/* FIRMA SOLO ULTIMA PAGINA */
doc.setPage(doc.getNumberOfPages());
await addSignature();

/* NUMERACION */
const totalPages=doc.getNumberOfPages();

for(let i=1;i<=totalPages;i++){
doc.setPage(i);
doc.setFontSize(9);
doc.text(`P치gina ${i} de ${totalPages}`,pageWidth/2,pageHeight-10,null,null,"center");
}

doc.save(nombre+".pdf");
}
</script>

</body>
</html>
