<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO MAX</title>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:white}
.lane{background:#111827;padding:15px;margin:10px 0;border-radius:15px;text-align:center;}
.timeDisplay{font-size:22px;font-weight:bold;margin:10px 0;}
.hidden{display:none}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
.small-btn{padding:5px;font-size:12px;margin-top:5px;width:auto;margin-right:5px;}
</style>
</head>
<body>

<h2>üèä Sistema Competencia Elite PRO MAX</h2>

<div id="loginCard" class="card">
<h3>Iniciar Sesi√≥n</h3>
<input type="text" id="loginUser" placeholder="Usuario">
<input type="password" id="loginPass" placeholder="Contrase√±a">
<button class="btn" onclick="login()">Ingresar</button>
</div>

<div id="app" class="hidden">

<button class="btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>

<div class="card">
<h3>Atletas</h3>
<input type="text" id="newAthleteUser" placeholder="Nombre atleta">
<input type="password" id="newAthletePass" placeholder="Contrase√±a">
<input type="number" id="newAthleteAge" placeholder="Edad">
<select id="newAthleteSex">
<option value="">Sexo</option>
<option value="Masculino">Masculino</option>
<option value="Femenino">Femenino</option>
</select>
<button class="btn-success" onclick="createAthlete()">Crear Atleta</button>
<button class="btn" onclick="downloadAthletes()">Descargar Todos los Atletas</button>
<div id="athleteList"></div>
</div>

<div class="card">
<h3>üìã Datos de la Prueba</h3>
<input type="text" id="testName" placeholder="Nombre prueba">
<input type="number" id="testDistance" placeholder="Metros">
<input type="date" id="testDate">
<button class="btn-success" onclick="activateTest()">Activar Prueba</button>
<div id="activeTestInfo"></div>
</div>

<div class="card">
<h3>Competencia</h3>
<input type="number" id="laneCount" value="4" min="2" max="10">
<button class="btn-success" onclick="startCompetition()">Crear Carriles</button>
<button class="btn-success" onclick="startRaceNow()">üö¶ INICIAR</button>
<button class="btn-warning" onclick="pauseRace()">‚è∏ Pausar</button>
<button class="btn-success" onclick="resumeRace()">‚ñ∂ Reanudar</button>
<button class="btn-danger" onclick="resetRace()">üîÑ Reiniciar</button>
<div id="lanes"></div>
</div>

<div class="card">
<h3>Ranking</h3>
<div id="ranking"></div>
</div>

<div class="card">
<h3>Descargas de Pruebas</h3>
<button class="btn" onclick="downloadResults()">Descargar Historial Completo</button>

<h4>Descargar por Rango de Fechas</h4>
<input type="date" id="dateFrom">
<input type="date" id="dateTo">
<button class="btn" onclick="downloadByDate()">Descargar por Rango</button>
</div>

</div>

<script>

function safeParse(key){
try{return JSON.parse(localStorage.getItem(key))||[];}
catch{return [];}
}

let athletes=safeParse("athletes");
let allTests=safeParse("allTests");
let currentTest=null;

function login(){
loginCard.classList.add("hidden");
app.classList.remove("hidden");
renderAthletes();
}

function logout(){location.reload();}

/* ATLETAS */

function createAthlete(){
if(!newAthleteUser.value||!newAthletePass.value)return;
athletes.push({
user:newAthleteUser.value,
pass:newAthletePass.value,
age:newAthleteAge.value||"",
sex:newAthleteSex.value||""
});
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

function editAthlete(index){
let a=athletes[index];
let newUser=prompt("Editar nombre:",a.user);
if(!newUser)return;
let newPass=prompt("Editar contrase√±a:",a.pass);
let newAge=prompt("Editar edad:",a.age);
let newSex=prompt("Editar sexo:",a.sex);

athletes[index]={user:newUser,pass:newPass,age:newAge||"",sex:newSex||""};
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

function deleteAthlete(user){
athletes=athletes.filter(a=>a.user!==user);
localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

function renderAthletes(){
athleteList.innerHTML="";
athletes.forEach((a,index)=>{
athleteList.innerHTML+=`${a.user} | Edad: ${a.age||"-"} | Sexo: ${a.sex||"-"}
<button class="small-btn btn-warning" onclick="editAthlete(${index})">Editar</button>
<button class="small-btn btn-danger" onclick="deleteAthlete('${a.user}')">Eliminar</button><br>`;
});
}

function downloadAthletes(){
let text="LISTA DE ATLETAS\n\n";
athletes.forEach(a=>{
text+=`Nombre: ${a.user}\nEdad: ${a.age||"-"}\nSexo: ${a.sex||"-"}\n\n`;
});
let blob=new Blob([text],{type:"text/plain"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="atletas.txt";
a.click();
}

/* PRUEBAS */

function activateTest(){
if(!testName.value||!testDistance.value||!testDate.value)return;
currentTest={name:testName.value,distance:testDistance.value,date:testDate.value,results:[]};
allTests.push(currentTest);
localStorage.setItem("allTests",JSON.stringify(allTests));
activeTestInfo.innerHTML=`Activa: ${currentTest.name} - ${currentTest.distance}m`;
}

/* CRONOMETRO */

let results=[];
let laneTimers={};
let globalInterval=null;
let raceStarted=false;
let paused=false;
let startTime=0;
let elapsed=0;

function startCompetition(){
lanes.innerHTML="";
results=[];
laneTimers={};
clearInterval(globalInterval);
raceStarted=false;
paused=false;
elapsed=0;

for(let i=1;i<=laneCount.value;i++){
laneTimers[i]={finished:false,currentTime:0,athlete:null};
lanes.innerHTML+=`
<div class="lane">
Carril ${i}
<div class="timeDisplay" id="time${i}">0.000</div>
<button onclick="finishLane(${i})">TOCAR</button>
</div>`;
}
}

function startRaceNow(){
if(raceStarted)return;
raceStarted=true;
paused=false;
startTime=Date.now();
globalInterval=setInterval(updateTimers,10);
}

function updateTimers(){
if(!raceStarted)return;

let currentElapsed = paused
? elapsed
: elapsed + (Date.now() - startTime);

for(let i in laneTimers){
if(!laneTimers[i].finished){
laneTimers[i].currentTime=currentElapsed;
document.getElementById("time"+i).innerText=(currentElapsed/1000).toFixed(3);
}
}
}

function pauseRace(){
if(!raceStarted || paused)return;
paused=true;
elapsed += Date.now() - startTime;
}

function resumeRace(){
if(!paused)return;
paused=false;
startTime=Date.now();
}

function resetRace(){
clearInterval(globalInterval);
raceStarted=false;
paused=false;
elapsed=0;
results=[];
ranking.innerHTML="";
for(let i in laneTimers){
laneTimers[i].finished=false;
laneTimers[i].currentTime=0;
document.getElementById("time"+i).innerText="0.000";
}
}

function finishLane(i){
if(!raceStarted||laneTimers[i].finished)return;
laneTimers[i].finished=true;
let finalTime=laneTimers[i].currentTime/1000;
results.push({lane:i,time:finalTime});
if(currentTest){
currentTest.results.push({
athlete:"Carril "+i,
tiempoCronometro:finalTime,
tiempoManual:0
});
localStorage.setItem("allTests",JSON.stringify(allTests));
}
renderRanking();
}

function renderRanking(){
ranking.innerHTML="";
results.sort((a,b)=>a.time-b.time);
results.forEach((r,i)=>{
ranking.innerHTML+=`${i+1}¬∞ Carril ${r.lane} - ${r.time.toFixed(3)}s<br>`;
});
}

/* DESCARGAS */

function downloadResults(){
let text="HISTORIAL COMPLETO\n\n";
allTests.forEach(t=>{
text+=`Fecha: ${t.date}\nPrueba: ${t.name}\n\n`;
t.results.forEach(r=>{
let cron=r.tiempoCronometro||0;
let man=r.tiempoManual||0;
text+=`${r.athlete} - Crono:${cron.toFixed(3)} - Manual:${man.toFixed(3)}\n`;
});
text+="\n";
});
let blob=new Blob([text],{type:"text/plain"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="historial_completo.txt";
a.click();
}

function downloadByDate(){

let from=dateFrom.value;
let to=dateTo.value;
if(!from||!to)return alert("Selecciona rango");

let filtered=allTests.filter(t=>t.date>=from && t.date<=to);
if(filtered.length===0)return alert("No hay pruebas");

let grouped={};
filtered.forEach(t=>{
if(!grouped[t.date])grouped[t.date]=[];
grouped[t.date].push(t);
});

let text="HISTORIAL POR FECHAS\n\n";

Object.keys(grouped).sort().forEach(date=>{
text+="============================\n";
text+="FECHA: "+date+"\n";
text+="============================\n\n";
grouped[date].forEach(test=>{
text+="Prueba: "+test.name+"\n";
test.results.forEach(r=>{
let cron=r.tiempoCronometro||0;
let man=r.tiempoManual||0;
text+=`${r.athlete} - Crono:${cron.toFixed(3)} - Manual:${man.toFixed(3)}\n`;
});
text+="\n";
});
});

let blob=new Blob([text],{type:"text/plain"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="historial_por_rango.txt";
a.click();
}

</script>
</body>
</html>
