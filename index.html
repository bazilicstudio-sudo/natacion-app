<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Competencia Elite PRO MAX</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white;padding:10px;}
.card{background:#1f2937;padding:15px;border-radius:15px;margin-bottom:15px;}
button{padding:10px;margin:5px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;}
.btn{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
.btn-danger{background:#dc2626;color:white}
.btn-warning{background:#f59e0b;color:white}
.lane{background:#111827;padding:15px;margin:10px 0;border-radius:15px;text-align:center;}
.timeDisplay{font-size:22px;font-weight:bold;margin:10px 0;}
.hidden{display:none}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
.small-btn{padding:5px;font-size:12px;margin-top:5px;width:auto;margin-right:5px;}
</style>
</head>
<body>

<h2>üèä Sistema Competencia Elite PRO MAX</h2>

<div id="loginCard" class="card">
<h3>Iniciar Sesi√≥n</h3>
<input type="text" id="loginUser" placeholder="Usuario">
<input type="password" id="loginPass" placeholder="Contrase√±a">
<button class="btn" onclick="login()">Ingresar</button>
</div>

<div id="app" class="hidden">

<button class="btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>

<!-- ================= ENTRENADOR ================= -->

<div class="card">
<h3>üë®‚Äçüè´ Entrenador</h3>
<input type="text" id="coachName" placeholder="Nombre entrenador">
<label>Marca de agua</label>
<input type="file" id="watermarkInput" accept="image/*">
<label>Firma</label>
<input type="file" id="signatureInput" accept="image/*">
<button class="btn-success" onclick="saveCoach()">Guardar Entrenador</button>
<div id="coachInfo"></div>
</div>

<!-- ================= ATLETAS ================= -->

<div class="card">
<h3>Atletas</h3>
<input type="text" id="newAthleteUser" placeholder="Nombre atleta">
<input type="password" id="newAthletePass" placeholder="Contrase√±a">
<input type="number" id="newAthleteAge" placeholder="Edad">
<select id="newAthleteSex">
<option value="">Sexo</option>
<option value="Masculino">Masculino</option>
<option value="Femenino">Femenino</option>
</select>
<button class="btn-success" onclick="createAthlete()">Crear Atleta</button>
<div id="athleteList"></div>
</div>

<!-- ================= PRUEBAS ================= -->

<div class="card">
<h3>üìã Datos de la Prueba</h3>
<input type="text" id="testName" placeholder="Nombre prueba">
<input type="number" id="testDistance" placeholder="Metros">
<input type="date" id="testDate">
<button class="btn-success" onclick="activateTest()">Activar Prueba</button>
<div id="activeTestInfo"></div>
</div>

<!-- ================= COMPETENCIA ================= -->

<div class="card">
<h3>Competencia</h3>
<input type="number" id="laneCount" value="4" min="2" max="10">
<button class="btn-success" onclick="startCompetition()">Crear Carriles</button>
<button class="btn-success" onclick="startRaceNow()">üö¶ INICIAR</button>
<button class="btn-danger" onclick="resetRace()">üîÑ Reiniciar</button>
<div id="lanes"></div>
</div>

<div class="card">
<h3>Ranking</h3>
<div id="ranking"></div>
</div>

<!-- ================= DESCARGAS ================= -->

<div class="card">
<h3>üì• Descargas Profesionales</h3>

<button class="btn" onclick="downloadFull()">Descargar Historial Completo</button>

<select id="downloadAthleteSelect"></select>
<button class="btn-success" onclick="downloadByAthlete()">Descargar por Atleta</button>

<input type="date" id="downloadDate">
<button class="btn-warning" onclick="downloadByDate()">Descargar por Fecha</button>

<select id="downloadTestSelect"></select>
<button class="btn-danger" onclick="downloadByTest()">Descargar por Prueba</button>

</div>

</div>

<script>

/* ================= BASE ================= */

function safeParse(key){
try{return JSON.parse(localStorage.getItem(key))||[];}
catch{return [];}
}

let athletes=safeParse("athletes");
let allTests=safeParse("allTests");
let currentTest=null;

function login(){
loginCard.classList.add("hidden");
app.classList.remove("hidden");
renderAll();
}

function logout(){location.reload();}

/* ================= ENTRENADOR ================= */

let coach = JSON.parse(localStorage.getItem("coach")) || {};

function saveCoach(){

coach.name = coachName.value;

let wmFile = watermarkInput.files[0];
let signFile = signatureInput.files[0];

if(wmFile){
let reader = new FileReader();
reader.onload = e=>{
coach.watermark = e.target.result;
localStorage.setItem("coach",JSON.stringify(coach));
};
reader.readAsDataURL(wmFile);
}

if(signFile){
let reader2 = new FileReader();
reader2.onload = e=>{
coach.signature = e.target.result;
localStorage.setItem("coach",JSON.stringify(coach));
};
reader2.readAsDataURL(signFile);
}

localStorage.setItem("coach",JSON.stringify(coach));
renderCoach();
}

function renderCoach(){
coachInfo.innerHTML = coach.name ? 
`Entrenador activo: <b>${coach.name}</b>` :
"No configurado";
}

renderCoach();

/* ================= ATLETAS ================= */

function createAthlete(){

if(!newAthleteUser.value) return alert("Ingrese nombre");

if(athletes.some(a=>a.user===newAthleteUser.value)){
alert("Ya existe un atleta con ese nombre");
return;
}

athletes.push({
user:newAthleteUser.value,
pass:newAthletePass.value,
age:newAthleteAge.value||"",
sex:newAthleteSex.value||""
});

localStorage.setItem("athletes",JSON.stringify(athletes));
renderAthletes();
}

function renderAthletes(){
athleteList.innerHTML="";
downloadAthleteSelect.innerHTML="";

athletes.forEach((a,index)=>{
athleteList.innerHTML+=`
<div style="margin-bottom:8px;padding:5px;background:#111827;border-radius:8px;">
<b>${a.user}</b> | Edad:${a.age||"-"} | Sexo:${a.sex||"-"}
</div>`;

downloadAthleteSelect.innerHTML+=`<option value="${a.user}">${a.user}</option>`;
});
}

/* ================= PRUEBAS ================= */

function activateTest(){
if(!testName.value || !testDate.value){
alert("Complete nombre y fecha");
return;
}

currentTest={
name:testName.value,
distance:testDistance.value,
date:testDate.value,
results:[]
};

allTests.push(currentTest);
localStorage.setItem("allTests",JSON.stringify(allTests));
activeTestInfo.innerHTML=`Activa: ${currentTest.name}`;
renderTests();
}

function renderTests(){
downloadTestSelect.innerHTML="";
allTests.forEach((t,i)=>{
downloadTestSelect.innerHTML+=`<option value="${i}">${t.name} - ${t.date}</option>`;
});
}

/* ================= PDF ================= */

async function generarPDF(texto,nombreArchivo){

const { jsPDF } = window.jspdf;
const doc = new jsPDF();

let fechaHora = new Date().toLocaleString();
let pageWidth = doc.internal.pageSize.getWidth();
let pageHeight = doc.internal.pageSize.getHeight();

doc.setFontSize(10);
doc.text(`Entrenador: ${coach.name || "No definido"}`, 10, 10);
doc.text(`Generado: ${fechaHora}`, pageWidth-60, 10);

let lines = doc.splitTextToSize(texto, 180);
let y = 20;

doc.setFontSize(12);

lines.forEach(line=>{
if(y > pageHeight-20){
doc.addPage();
y=20;
}
doc.text(line,15,y);
y+=7;
});

/* Marca de agua */
if(coach.watermark){
let totalPages = doc.getNumberOfPages();
for(let i=1;i<=totalPages;i++){
doc.setPage(i);
doc.addImage(coach.watermark,"PNG",
pageWidth*0.2,
pageHeight*0.2,
pageWidth*0.6,
pageHeight*0.6);
}
}

/* Firma solo √∫ltima p√°gina */
if(coach.signature){
let totalPages = doc.getNumberOfPages();
doc.setPage(totalPages);
doc.addImage(coach.signature,"PNG",
pageWidth-60,
pageHeight-30,
40,
20);
}

/* Numeraci√≥n */
let totalPages = doc.getNumberOfPages();
for(let i=1;i<=totalPages;i++){
doc.setPage(i);
doc.text(`P√°gina ${i} de ${totalPages}`, pageWidth/2-10, pageHeight-5);
}

doc.save(nombreArchivo+".pdf");
}

/* ================= DESCARGAS ================= */

function generarTexto(test){
let texto=`PRUEBA: ${test.name}\nDistancia: ${test.distance||"-"}m\nFecha: ${test.date}\n\n`;
test.results.forEach(r=>{
texto+=`${r.athlete} - ${r.time.toFixed(3)}s\n`;
});
return texto;
}

function downloadFull(){
let texto="";
allTests.forEach(t=>texto+=generarTexto(t)+"\n");
generarPDF(texto,"historial_completo");
}

function downloadByAthlete(){
let atleta=downloadAthleteSelect.value;
let texto="";
allTests.forEach(t=>{
t.results.forEach(r=>{
if(r.athlete===atleta){
texto+=`${t.name} - ${r.time.toFixed(3)}s\n`;
}
});
});
generarPDF(texto,`historial_${atleta}`);
}

function downloadByDate(){
let fecha=downloadDate.value;
let texto="";
allTests.forEach(t=>{
if(t.date===fecha){
texto+=generarTexto(t)+"\n";
}
});
generarPDF(texto,`historial_${fecha}`);
}

function downloadByTest(){
let index=downloadTestSelect.value;
let test=allTests[index];
generarPDF(generarTexto(test),`historial_${test.name}`);
}

function renderAll(){
renderAthletes();
renderTests();
}

</script>
</body>
</html>
